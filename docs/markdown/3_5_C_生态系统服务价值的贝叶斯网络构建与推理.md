> Created on Fri May 19 22:11:12 2023 @author: Richie Bao-caDesign设计(cadesign.cn)

# 3.5-C 生态系统服务价值的贝叶斯网络构建与推理

## 3.5.1 生态系统服务价值（估值）与 InVEST 和 NWV 计算工具

### 3.5.1.1 生态系统服务

**生态系统（ecosystem，ecological system）**：由所有生物体（organisms）和它们相互作用的物理环境（physical environment，指自然环境中的非生物因素，如气候、地形、土壤等，对生物体和生态系统产生影响的各种自然条件）组成<sup>[1]458</sup>。这些生物和非生物成分通过营养循环（nutrient cycles）和能量流（energy flows）联系在一起。能量通过光合（photosynthesis）作用进入系统并融入植物组织。动物通过以植物或者彼此为食，对生态系统的物质和能量流动起到重要作用，也影响到植物和微生物生物量的数量。通过分解死亡的有机物质，分解者将碳释放回大气，并通过将储存在死亡生物质中的营养物质转化为易于被植物和微生物利用的形式，促进营养循环<sup>[2]</sup>。
    
**生态系统服务（eco-services，ecosystem services ）**：是自然环境和健康的生态系统为人类提供的多种多样的福利（benefits）。这些生态系统包括诸如农业生态系统（agroecosystems）、森林生态系统（forest ecosystem）、草地生态系统（grassland ecosystems）和水生生态系统（aquatic ecosystems）等，其提供有农作物自然授粉、空气清洁、极端气候调节和有利于人类身心健康等好处。总的来说，这些好处被称为生态系统服务，通常与食物和清洁饮用水供给（provision）、废物分解和粮食生态系统（food ecosystems）的复原力和生产力密不可分<sup>[3]</sup>。
    
**生物多样性（biodiversity）**：指一个地区可以找到的不同种类的生命，这些生命例如各种各样的动物、植物、真菌，甚至微生物（如细菌）等，并构成了一个自然世界。这些物种和有机体在生态系统中一起工作，形成一个错综复杂的网络，以保持平衡和维持生命。生物多样性的变化影响生态系统服务的供给，支持着人类所需要的一切，例如事物、清洁的水资源、药品和住所等<sup>[4]</sup>。
    
* 生态系统服务的类型
    
[2005年千年生态系统评估（Millennium Ecosystem Assessment，MA）报告](https://www.millenniumassessment.org/en/Index-2.html)<sup>①</sup>将生态系统服务定义为人类从生态系统中获得的利益，并将生态系统服务分为四类，调节服务（Regulating services）、供给服务（Provisioning services）、文化服务（Cultural services）和支持服务（Supporting services），其中支持服务是其它三类服务的基础。一个生态系统不一定同时提供上述4类服务，且不同的生态系统（例如森林、海洋、珊瑚礁或红树林等）提供的服务在性质和结果上各不相同。同时，一些服务直接影响邻近人类的生计，例如淡水、食物或审美价值等；而有些服务会引发气候变化、水土流失或自然灾害，间接的影响人类社会<sup>[5]</sup>。生态系统服务类型的内容如下：
    
    
| 生态系统服务的类型  |  支持服务（Supporting services |  供给服务（Provisioning services | 调节服务（Regulating services）  |  文化服务（Cultural services） |
|---|---|---|---|---|
|  内容 |该功能是生态系统提供其它服务功能的基础，包括但不限于养分循环（nutrient cycling）、初级生产（primary production）、土壤形成（soil formation）、栖息地提供（habitat provision）等服务。   | </br>食物（包括海鲜和野味）、农作物、野生食物和香料（food (including seafood and game), crops, wild foods, and spices）</br>原材料（包括木材、毛皮、薪柴、有机物、饲料和肥料）（raw materials (including lumber, skins, fuelwood, organic matter, fodder, and fertilizer)）</br>遗传资源（包括作物改良基因和医疗保健）（genetic resources (including crop improvement genes, and health care)）</br>生物矿物（biogenic minerals）</br>医药资源（包括药品、化学模型以及测试和分析生物体）（medicinal resources (including pharmaceuticals, chemical models, and test and assay organisms)）</br>能源（水电、生物质燃料）（energy (hydropower, biomass fuels)）</br>观赏资源（包括时装、手工艺品、珠宝、宠物、崇拜、装饰和纪念品，如毛皮、羽毛、象牙、兰花、蝴蝶、观赏鱼、贝壳等）（ornamental resources (including fashion, handicrafts, jewelry, pets, worship, decoration, and souvenirs like furs, feathers, ivory, orchids, butterflies, aquarium fish, shells, etc.)）  |   水和空气的净化（Purification of water and air）</br>  碳封存和气候调节（Carbon sequestration and climate regulation）</br>废物分解和解毒（Waste decomposition and detoxification）</br>捕食对猎物数量的调节（Predation regulates prey populations）</br>对病虫害的生物防治（Biological control pest and disease control）</br>授粉（Pollination）</br> 扰动调节（防洪）（Disturbance regulation, i.e. flood protection） </br>| 文化（包括在书籍、电影、绘画、民俗、国家象征、广告等中使用自然作为主题）（cultural (including use of nature as motif in books, film, painting, folklore, national symbols, advertising, etc.)）</br>精神和历史（包括将自然用于宗教或遗产价值或自然）（spiritual and historical (including use of nature for religious or heritage value or natural)）</br>娱乐体验（包括生态旅游、户外运动和娱乐）（recreational experiences (including ecotourism, outdoor sports, and recreation)）</br>科学和教育（包括利用自然系统进行学校旅行和科学发现）（science and education (including use of natural systems for school excursions, and scientific discovery)）</br>治疗（包括生态疗法、社会林业和动物辅助疗法）（therapeutic (including eco-therapy, social forestry and animal assisted therapy)）</br>  |

> MA 对生态系统、生态系统服务功能和人类福利（福祉）给出了如下定义：生态系统是植物、 动物和微生物群落及其无机环境的动态复合体和相互作用功能单元，树洞里一个临时的 小水洼，以及辽阔的海洋盆地，都可以被称之为一个生态系统；生态系统服务功能是指 人类从生态系统中获得的效益，这些效益包括供给功能（如粮食与水的供给）、调节功 能（如调节洪涝、干旱、土地退化，以及疾病等）、支持功能（如土壤形成与养分循环 等）和文化功能（如娱乐、精神、宗教以及其它非物质方面的效益）；人类福利具有多 重成分，包括维持高质量的生活所需的基本物质条件、自由权与选择权、健康、良好的 社会关系，以及安全等<sup>[6]</sup>。

**生态系统服务价值（估值）（Ecosystem Valuation）**：是为生态系统服务分配价值（货币化（monetary）、生物物理化（biophysical,）等）的一个经济过程，例如量化森林在减少洪水和侵蚀、固碳、为濒危物种提供栖息地和吸收有害化学物质等人类的福祉。生态系统服务货币化的途径一定程度上可以为政策制定者和自然保护主义者提供一种评估管理影响和比较潜在政策成本效益的分析工具<sup>[7]</sup>。生态系统服务包括水、木材、鱼类等可以以市场价格出售的直接使用价值；也包括通过减缓气候变化使整个人类社会受益的间接使用价值，及其它类型的价值等。在价值计算上，存在享乐估值法（Hedonic valuation methods）、旅行费用计算方法（Travel cost methods）、陈述偏好法（stated preference method）和福祉转移法（ benefit transfer methods）等<sup>[8]</sup>。
    
生态系统服务价值（估值）的文献不断涌现，集成相关研究成果可以构建生态系统服务价值数据库，例如由 [Luke Brander](http://lukebrander.com/) <sup>②</sup>和[可持续发展基金会（Foundation for Sustainable Development，FSD）](https://fsd.nl/who-we-are/)<sup>③</sup>、[英国苏格兰农业学院（Scotlands Rural College，SRUC）](https://www.sruc.ac.uk/)<sup>④</sup>联合发布的 [ESVD（Ecosystem Services Valuation Database）](https://www.esvd.net/)<sup>⑤</sup>（以每年每公顷美元标准化）。ESVD 目前包含来自分布在所有生物群落、生态服务系统和地理区域 1,100 多项研究的 9,453 条价值记录，其用于估值的研究资料库超过 2,000 多项研究，且数量仍在持续增加，估值的记录数量也将继续增加。ESVD 的长期目标是提供有关生态系统和生物多样性经济效益及其损失成本可靠且易于获取的信息，以支持有关自然保护、生态系统修复的决策和可持续的土地管理。例如下图的 ESVD 搜索结果<sup>[9]</sup>：
    
<img src="./imgs/3_5_c/3_5_c_05.png" height='auto' width='auto' title="caDesign"> 

### 3.5.1.2 生态系统服务计算工具

* InVEST

目前较为系统的生态系统服务计算工具以[InVEST（Integrated Valuation of Ecosystem Services and Tradeoffs）](https://naturalcapitalproject.stanford.edu/software/invest)<sup>⑥</sup>为主。InVEST是一套免费的开源软件模型（基于 Python 语言），用于绘制和评估自然界中维持和充实人类生活的商品和服务，为自然资源管理决策提供信息。该工具的模型模块化开发，已开发的模块有

1. 年产水量（Annual Water Yield）、
2. 碳储存和封存（Carbon Storage and Sequestration）、
3. 海岸带蓝碳（Coastal Blue Carbon）、
4. 海岸脆弱性模型（Coastal Vulnerability Model）、
5. 作物生产（Crop Production）、
6. 森林碳边缘效应（Forest Carbon Edge Effect）、
7. 生境质量（Habitat Quality）、
8. 生境风险评估（Habitat Risk Assessment）、
9. 养分输送比（NDR: Nutrient Delivery Ratio）、
10. 海上风能生产（Offshore Wind Energy Production）、
11. 作物授粉（授粉者丰度）（Crop Pollination (Pollinator Abundance)）、
12. 泥沙输移比例模型（SDR: Sediment Delivery Ratio）、
13. 季节性产水量（Seasonal Water Yield）、
14. 景区质量（Scenic Quality）、
15. 城市降温模型（Urban Cooling Model）、
16. 城市洪水风险缓解模型（Urban Flood Risk Mitigation model）、
17. 城市自然空间可达性模型（Urban Nature Access）、
18. 城市暴雨滞留模型（Urban Stormwater Retention Model）、
19. 参观: 休闲和旅游业（Visitation: Recreation and Tourism）、
20. 波浪能生产（Wave Energy Production）等 20 个模型，

以及辅助工具情景生成器（Scenario Generator: Proximity Based）等。

因为 InVEST 基于 Python 编程语言开发，其提供了一个 Python [应用程序编程接口（application programming interface，API ）](https://invest.readthedocs.io/en/latest/)<sup>⑦</sup>，方便在 Python 编程环境下安装调用。同时，[NatCap（natural capital） 研究团队](https://naturalcapitalproject.stanford.edu/about/people)<sup>⑧</sup>开发了一个地理数据处理的 Python 包[PyGeoprocessing](https://pygeoprocessing.readthedocs.io/en/latest/)<sup>⑨</sup>，提供了一组常用栅格、矢量数据和水文相关的处理工具。

* NWV（NVE）

因为生态系统服务（ecosystem services，ESS）没有被商业市场充分捕捉，也没有被充分量化，无法与市场上交易的商业服务相比较，造成生态系统服务在政策决定中往往得不到充分重视。忽视生态系统服务的价值可能会导致生态系统过度开发或不合理的政策和投资决策。佛兰德（Flemish）政府认识到生态系统服务的重要性，其环境部请[VITO](https://vito.be/en)<sup>⑩</sup>（清洁技术和可持续发展领域的独立研究机构）、安特卫普大学和阿姆斯特丹大学（universities of Antwerp and Amsterdam）的经济学家和生态学家证实生态系统服务的重要性。构建的[Nature Value Explorer（NVE）（Natuur waarde verkenner（荷兰语），NWV）](https://www.natuurwaardeverkenner.be/#contact)<sup>⑪</sup>工具侧重于评估生态系统服务的实用方法，以便帮助绘制生态系统服务的社会经济价值。NWV 为在线网页工具的形式，仅服务于佛兰德地区，计算模型和代码并未开源，因此对世界上其它区域 NWV 仅适用于对生态系统服务计算工具这一构建方式的参考。

## 3.5.2 碳储存和封存/固碳（Carbon Storage and Sequestration）

全球气候变化导致极端气候事件频发，影响日渐深重，成为21世纪人类共同面临的最重大环境挑战<sup>[10]</sup>。从21世纪初至2019年，全球温室气体（greenhouse gas，GHG）排放呈上升趋势，其中我国等新兴经济体的二氧化碳排放量增加为主要原因。大气中温室气体浓度大幅度增加，增强了自然温室效应，这可能对地球上的生命产生负面影响<sup>[11]</sup>。《联合国气候变化框架公约》( United Nations Framework Convention on Climate Change，UNFCCC)建立了一项国际环境条约，以应对“人类对气候系统的危险干扰”，部分手段是稳定大气中的温室气体浓度。尽管如此，作为全球变暖的二氧化碳排放量仍在世界范围内增加。在此背景下，[全球大气研究排放数据库（Emissions Database for Global Atmospheric Research，EDGAR）](https://edgar.jrc.ec.europa.eu/)<sup>⑫</sup>就[政府间气候变化专门委员会（Intergovernmental Panel on Climate Change，IPCC）](https://www.ipcc.ch/)<sup>⑬</sup>的最新指南和最近的活跃数据，为世界各国提供了独立的温室气体估算，并在2022年9月发布了最新更新，可以获得1970-2021年期间化石燃料$CO_2$的排放数据，可以从[EDGAR](https://edgar.jrc.ec.europa.eu/report_2022)<sup>⑭</sup>下载<sup>[12]</sup>。

为了交互可视化二氧化碳排放数据，使用Python的[Dash（plotly）](https://dash.plotly.com/installation)<sup>⑮</sup>库，可交互的图表工具可视化分析数据，完成的代码可以从托管于GitHub的[USDA_dashboard](https://github.com/richieBao/USDA_dashboard)<sup>⑯</sup>代码库下载，文件名为'dash_fossil_CO2_emissions_2022.py'。


```python
# Import packages
from dash import Dash, html, dash_table, dcc, callback, Output, Input
import pandas as pd
import geopandas as gpd
import plotly.express as px
import plotly.graph_objects as go
import dash_mantine_components as dmc
import numbers
import json
import numpy as np

ghg_fn='./data/EDGARv7.0_FT2021_fossil_CO2_booklet_2022.xlsx'
ghg_df=pd.ExcelFile(ghg_fn)
print(ghg_df.sheet_names)
# ['info', 'fossil_CO2_totals_by_country', 'fossil_CO2_by_sector_and_countr', 'fossil_CO2_per_GDP_by_country', 'fossil_CO2_per_capita_by_countr', 'LULUCF by macro regions']
fossil_CO2_totals_by_country=pd.read_excel(ghg_fn,sheet_name='fossil_CO2_totals_by_country').round(3)
fossil_CO2_by_sector_and_country=pd.read_excel(ghg_fn,sheet_name='fossil_CO2_by_sector_and_countr').round(3)
fossil_CO2_per_GDP_by_country=pd.read_excel(ghg_fn,sheet_name='fossil_CO2_per_GDP_by_country').round(3)
fossil_CO2_per_capita_by_country=pd.read_excel(ghg_fn,sheet_name='fossil_CO2_per_capita_by_countr').round(3)
LULUCF_by_macro_regions=pd.read_excel(ghg_fn,sheet_name='LULUCF by macro regions').round(3)
keys_year=[i for i in fossil_CO2_totals_by_country.columns if isinstance(i,numbers.Number)]

countries_fn=r'./data/countries.geojson' 
countries_gdf=gpd.read_file(countries_fn)

# Initialize the app - incorporate a Dash Mantine theme
external_stylesheets = [dmc.theme.DEFAULT_COLORS]
app = Dash(__name__, external_stylesheets=external_stylesheets)

tabs_styles = {
    'height': '44px'
}

tab_style = {
    'borderBottom': '1px solid #d6d6d6',
    'padding': '6px',
    'fontWeight': 'bold'
}

tab_selected_style = {
    'borderTop': '1px solid #d6d6d6',
    'borderBottom': '1px solid #d6d6d6',
    'backgroundColor': '#119DFF',
    'color': 'white',
    'padding': '6px'
}

# App layout
app.layout = dmc.Container([
    dmc.Title(r'各国【化石】二氧化碳排放量（Fossil CO_2 emissions by country）', color="blue", size="h3"),
    dcc.Tabs(id='tabs_co2',value='tab-1',children=[
        dcc.Tab(label='fossil CO2 totals by country', value='tab-1', style=tab_style, selected_style=tab_selected_style),
        dcc.Tab(label='fossil CO2 by sector_and_country', value='tab-2', style=tab_style, selected_style=tab_selected_style),
        dcc.Tab(label='fossil CO2 per GDP by country', value='tab-3', style=tab_style, selected_style=tab_selected_style),
        dcc.Tab(label='fossil CO2 per capita by country', value='tab-4', style=tab_style, selected_style=tab_selected_style),
        dcc.Tab(label='LULUCF by macro regions', value='tab-5', style=tab_style, selected_style=tab_selected_style),
        ],style=tabs_styles),
    html.Div(id='tabs-content-inline'),
    html.Label(r'历年 CO_2 排放量:（选择国家）'),
    dcc.Dropdown(
        fossil_CO2_totals_by_country['Country'].tolist(),['China','United States','India','Russia','United Kingdom','Iran'],multi=True,id='countries4co2totals'                
        ), 
    dcc.Graph(id='co2_totals'),  
    html.Label(r'历年 CO_2 排放量地图'),     
    dcc.Graph(id='co2_worldmap'),
    dcc.Slider(id='year-slider',min=min(keys_year),max=max(keys_year),marks={x: {'label': str(x)} for x in range(min(keys_year),max(keys_year))},value=2018),
    ],
    fluid=True
    )

@app.callback(Output('tabs-content-inline', 'children'),
              Input('tabs_co2', 'value'))
def render_co2_tables(tab):
    if tab == 'tab-1':
        return html.Div([
            dash_table.DataTable(data=fossil_CO2_totals_by_country.to_dict('records'), page_size=11, style_table={'overflowX': 'auto'},columns=[{"name": str(i), "id": str(i)} for i in fossil_CO2_totals_by_country.columns]),
                      ])
    elif tab == 'tab-2':
        return html.Div([
            dash_table.DataTable(data=fossil_CO2_by_sector_and_country.to_dict('records'), page_size=11, style_table={'overflowX': 'auto'},columns=[{"name": str(i), "id": str(i)} for i in fossil_CO2_by_sector_and_country.columns]),
        ])
    elif tab == 'tab-3':
        return html.Div([
            dash_table.DataTable(data=fossil_CO2_per_GDP_by_country.to_dict('records'), page_size=11, style_table={'overflowX': 'auto'},columns=[{"name": str(i), "id": str(i)} for i in fossil_CO2_per_GDP_by_country.columns]),
        ])
    elif tab == 'tab-4':
        return html.Div([
            dash_table.DataTable(data=fossil_CO2_per_capita_by_country.to_dict('records'), page_size=11, style_table={'overflowX': 'auto'},columns=[{"name": str(i), "id": str(i)} for i in fossil_CO2_per_capita_by_country.columns]),
        ])
    elif tab == 'tab-5':
        return html.Div([
            dash_table.DataTable(data=LULUCF_by_macro_regions.to_dict('records'), page_size=11, style_table={'overflowX': 'auto'},columns=[{"name": str(i), "id": str(i)} for i in LULUCF_by_macro_regions.columns]),
        ])
    
@app.callback(Output('co2_totals', 'figure'),
               Input('countries4co2totals', 'value'))   
def update_co2_totals_by_country(countries):
    df=fossil_CO2_totals_by_country[fossil_CO2_totals_by_country.Country.isin(countries)] 
    df_ys=df[keys_year+['Country']]
    df_melted=df_ys.melt('Country', value_name='vals')
    fig=px.line(df_melted,x='variable',y='vals',color='Country',markers=True).update_layout(plot_bgcolor='rgba(0, 0, 0, 0)',yaxis_title=r'CO_2 totals (Mt CO2/yr)',xaxis_title="Year")
    fig.update_yaxes(gridcolor='lightgrey')
    fig.update_xaxes(gridcolor='lightgrey')
    
    return fig
    
@app.callback(
    Output('co2_worldmap', 'figure'),
    Input('year-slider', 'value'))
def update_co2_worldmap(selected_year):
    df_ys=fossil_CO2_totals_by_country[keys_year+['Country','EDGAR Country Code']]
    df_melted=df_ys.melt(['Country','EDGAR Country Code'], value_name='vals')
    df_melted_yr=df_melted[df_melted['variable']==selected_year]
    countries_copy_gdf=countries_gdf.copy(deep=True)
    
    def merging(row):      
        try:
            key=row['ISO_A3']
            selection=df_melted_yr[df_melted_yr['EDGAR Country Code']==key]
            return pd.Series(selection[['Country','vals']].values[0])
        except:
            return pd.Series([np.nan,np.nan])   
    countries_copy_gdf[['Country','vals']]=countries_copy_gdf.apply(merging,axis=1)
    
    fig = go.Figure(px.choropleth_mapbox(countries_copy_gdf, 
                                         geojson=countries_copy_gdf.geometry,
                                         locations=countries_copy_gdf.index,
                                         color='vals',
                                         color_continuous_scale='thermal', # px.colors.diverging.BrBG, "Viridis",
                                         mapbox_style="open-street-map", # "carto-positron",
                                         zoom=3, center = {"lat": 37.0902, "lon": -95.7129},
                                         opacity=0.5,
                                         hover_data=["Country", "vals"],
                                         # height=1000,
                                         ))    
    
    return fig

if __name__ == '__main__':
    app.run_server(debug=True)
```

执行该代码，结果如下图。

<img src="./imgs/3_5_c/3_5_c_01.png" height='auto' width='auto' title="caDesign"> 

> [可查看联合国环境规划署（United Nations Environment Programme）对世界各国温室气体（$CO_2$）数据的可视化描述](https://www.unep.org/explore-topics/climate-action/what-we-do/climate-action-note/state-of-climate.html)<sup>⑰</sup>。

从数据可视化图表可以得知，我国的二氧化碳排放量在2005年超过美国并一路攀升，高达美国排放量的约2倍，在2021年达到 12466 亿吨（$Mt CO_2/yr$）。在2020年9月的第75届联合国大会上，我国郑重宣誓$CO_2$的排放力争于2030年前达到峰值，2060年前实现碳中和，即“双碳”目标。应对气候变化关键在于“控碳”，先实现碳达峰，再实现碳中和，后者更加重要，也更加困难。除通过调整产业结构、提高能源利用率、推广新能源等措施切实降低$CO_2$等温室气体排放外，同时通过生态系统服务，森林、草地、泥炭沼泽和其它陆生生态系统的碳汇能力，调节地球气候<sup>[13]</sup>。

1992年，UNFCCC 首次定义了碳汇（carbon sink），为从大气中清除$CO_2$的过程、活动或机制，即各种载体（森林、植被、水体、土壤、湿地等）通过其生态原理，吸收、储存和固定$CO_2$的过程，活动或机制，当其固碳量大于排放量时，称该过程为碳汇<sup>[14]</sup>。为了增强生态系统功能和生态产品供给能力，提升生态系统碳汇增量，除了各国政府采取切实的行动之外，国内外学者开展了广泛的研究探索。自1992年以来，碳汇相关研究发文量持续增长，研究内容涉及：在相关政策与理论研究方面的森林等生态系统的碳汇效能，低碳城市的发展策略，城乡绿色基础服务设施的碳汇能力建设任务与路径的探索；在碳汇计量与评估方面，相关研究从聚焦单一生态要素碳汇能力评估，发展到面向绿色空间全要素碳汇的综合评估，包括碳源、碳汇、碳储存和封存的计量监测，开发有[InVEST（Integrated Valuation of Ecosystem Services and Tradeoffs）](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/index.html)<sup>⑥</sup>，[NWV（Nature Value Explorer）](https://www.natuurwaardeverkenner.be/)<sup>⑪</sup>等面向生态系统服务评估的综合模型（计算工具）；在碳汇影响机制方面，宏观层面倾向于蓝绿空间的数量与空间格局对碳汇效能的影响机制，及土地利用和覆盖（landuse and landcover，LULC）、人口规模、经济发展程度等经济社会因素对碳汇的驱动机制研究。微观层面倾向于单值植物、植物配置、土壤类型、全生命周期评估等；在以增汇为导向的城乡蓝绿空间优化途径方面，相关研究着眼于宏观系统构建增量和微观个体增效提质为蓝绿空间规划和建设提出优化策略<sup>[15]</sup>。

当前的研究涉猎广泛，从微观到宏观，从定性到定量，包含生态、环境、规划、经济、社会、计算机等众多学科交叉。在未来的研究上，可以进一步拓展大数据在气候变化和碳汇等领域的应用；用机器学习预测不同气候情境下各生态系统的碳汇量和变化；扩大生态系统的类型研究，从森林生态系统到湿地、草地、海洋和岩石风化等；并利用系统论的原理研究系统整体和部分之间的关系，统筹、协调和权衡生态系统和经济社会的矛盾；进一步探索全生命周期下碳汇功能评估<sup>[16]</sup>。

### 3.5.2.1 NWV 的碳相关计算

NWV 在调节服务（regulating services）中的调节物理、化学和生物环境（Regulating the physical, chemical and biological environment）下提供有对全球气候变化影响有关的[土壤中的碳封存](https://natuurwaardeverkenner.be/docs/manual_EN/regulerende_diensten/omgeving/carbonsoil)<sup>⑱</sup>和[生物质能（biomass）中的碳封存](https://natuurwaardeverkenner.be/docs/manual_EN/regulerende_diensten/omgeving/carbonbiomass)<sup>⑲</sup>计算。

对于土壤的碳封存，NWV 采用多元回归方法评估比利时弗兰德斯（Flanders, Belgium）土壤有机碳（soil organic carbon，SOC）的空间分布及其对土壤特征的依赖性。基于这个回归模型，给定植被类型、土壤排水等级和土壤质地计算土壤潜在最大含碳量<sup>[17]</sup>。土壤排水和植被的变化都会改变潜在的最大含碳量。而年固碳潜力是潜在含碳量和实际含碳量之差的百分比<sup>[18,19]</sup>。碳封存的社会价值（货币化（monetary））计算使用缓解气候变化减排措施的成本作为指标。相关研究估计2010年比利时的减排成本为10至60欧元/吨（$CO_2$），且为了达到控制全球气温增高$2^ \circ $的目标<sup>[20]</sup>，减排成本还会增加，因此 NWV 目前使用2020年30欧元/吨（$CO_2$）的较低值，和100欧元/吨（$CO_2$）的较高值计算<sup>[21]</sup>。

对于生物质能中的碳封存，NWV 中的计算仅限于森林生态系统的吸收，使用特定物种的碳密度（carbon density）推导出每年每公顷森林的年度固碳量来计算其增量<sup>[22]</sup>。碳封存的货币化值同土壤的碳封存。

[NWV 生态系统服务在线计算](https://www.natuurwaardeverkenner.be/)<sup>⑳</sup>的数据为比利时弗兰德斯区域，下述圈画了一个区域进行计算，查看计算流程、输入条件和计算结果等情况，并仅计算土壤和生物质能的碳封存。在`Measures`阶段，假设新规划了一块混交林，和一个大面积的池塘；在`Extra Info`阶段，假设圈选区域当前不具有较高的生物多样性和存在受保护的物种，但在将来会采取额外的措施加强生物多样性并保护或恢复一些物种。同时，配置该区域可达，步道占比0.1%。

<img src="./imgs/3_5_c/3_5_c_02.png" height='auto' width=1024  title="caDesign"> 

NWV 生成了可视化计算结果报告，并提供相关数据的下载服务。因为增加了混交林和池塘，生物价值（biological value）、珍稀物种（Rareness）、生物质量（Biological quality）均有所提升。

<img src="./imgs/3_5_c/3_5_c_03.png" height='auto' width='auto' title="caDesign"> 

在年度的社会影响上，由于碳封存量的增加，可避免的减排成本（即碳封存的经济货币价值），避免的碳排放量，及栖息地的价值都在增加。

<img src="./imgs/3_5_c/3_5_c_04.png" height='auto' width=1024 title="caDesign"> 

报告中给出了土壤和生物质能碳封存结果，及对应的货币价值，也可以从下载的数据文件中查看。从结果来看，每年土壤中的碳储量增加了 29.3 吨/年（$CO_2$），生物质能中增加了 9.7 吨/年（$CO_2$；土壤和生物质能碳封存的社会经济价值变化幅度为`[3903,14287](欧元/年)`。

| Quantitative valuation                                      | Unit            | Present |       | Future |       | Difference |      |
|-------------------------------------------------------------|-----------------|---------|-------|--------|-------|------------|------|
|                                                             |                 | Low     | High  | Low    | High  | Low        | High |
| Global climate regulation - Carbon sequestration in soils   | tonnes C / year | 260.9   | 260.9 | 290.2  | 290.2 | 29.3       | 29.3 |
| Global climate regulation - Carbon sequestration in biomass | tonnes C / year | 12.2    | 12.2  | 21.9   | 21.9  | 9.7        | 9.7  |

| Monetary valuation                                          | Unit       | Difference future - present |       |
|-------------------------------------------------------------|------------|-----------------------------|-------|
|                                                             |            | Low                         | High  |
| Global climate regulation - Carbon sequestration in soils   | € / year | 2928                        | 10719 |
| Global climate regulation - Carbon sequestration in biomass | € / year | 975                         | 3568  |
| Total                                                       | € / year | 3903                        | 14287 |

### 3.5.2.2 InVEST 的碳相关计算

目前 InVEST 工具提供有[碳储存和封存](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/carbonstorage.html) <sup>㉑</sup>，[海岸带蓝碳（Coastal Blue Carbon）](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/coastal_blue_carbon.html)<sup>㉒</sup>和[森林碳边缘效应（Forest Carbon Edge Effect）](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/carbon_edge.html)<sup>㉓</sup>等碳相关计算模型。就 InVEST 的碳储存和封存模型，使用土地利用地图，及其对应包含有地上与地下生物量（biomass）、土壤及死的有机物质（dead organic matter）等4个碳库的存量来估算景观中当前储存的碳量，和随时间推移的碳封存量。并可使用碳封存的市场或社会价值，年变化率和折价率（discount rate）估计碳储存和封存做为调节服务对社会的价值<sup>[23]</sup>。InVEST 提供有[案例数据](http://releases.naturalcapitalproject.org/?prefix=invest/3.13.0/data/)<sup>㉔</sup>，提供的威拉米特（willamette）区域的土地利用/覆盖（LULC）数据包含有102个分类（含1个未知分类），碳库数据应该有一一对应分类的值。提供的碳库文件单位为 吨/公顷（t/ha），LULC 栅格高空分辨率为 30m，计算每一栅格单元的碳储量需要将碳库中各分类的每公顷碳储量转换为每$30 \times 30$单位的碳储量计算碳库中的碳储存地图，对应InVEST中的代码如下：

```python
def _generate_carbon_map(self,lulc_path, carbon_pool_by_type, out_carbon_stock_path):
    """Generate carbon stock raster by mapping LULC values to carbon pools.

    Args:
        lulc_path (string): landcover raster with integer pixels.
        out_carbon_stock_path (string): path to output raster that will have
            pixels with carbon storage values in them with units of Mg*C
        carbon_pool_by_type (dict): a dictionary that maps landcover values
            to carbon storage densities per area (Mg C/Ha).

    Returns:
        None.
    """
    lulc_info = pygeoprocessing.get_raster_info(lulc_path)
    pixel_area = abs(numpy.prod(lulc_info['pixel_size']))
    carbon_stock_by_type = dict([
        (lulcid, stock * pixel_area / 10**4)
        for lulcid, stock in carbon_pool_by_type.items()]) 
    reclass_error_details = {
        'raster_name': 'LULC', 'column_name': 'lucode',
        'table_name': 'Carbon Pools'}
    utils.reclassify_raster(
        (lulc_path, 1), carbon_stock_by_type, out_carbon_stock_path,gdal.GDT_Float32, _CARBON_NODATA, reclass_error_details)                 
```

如果提供了当前和未来的LULC地图，就可以计算碳储量随时间变化的净变化（net change），即封存和损失（sequestration and loss），计算的方法为两个时期碳储存地图栅格差值。同时，也可以提供减少森林砍伐和退化 （reduced (carbon) emissions from deforestation and degradation ，REDD）政策情景下的LULC地图，用于支持政府、非政府组织和企业的一系列决策下 LULC 变化的场景分析（Scenario Analysis）。

将碳封存（不是碳储存）货币化转换为经济价值衡量标准，其计算公式为：$value\_seq_x=V\frac{s_x}{q-p}\sum^{q-p-1}_{t=0}\frac{1}{\left(1+\frac{r}{100}\right)^t\left(1+\frac{c}{100}\right)^t}$，式中，$V$是每公吨碳的价格，为每公吨元素碳的价格（不是$CO_2$），推荐用释放一吨碳造成的相关环境损害成本-碳的社会成本（social cost of carbon，SCC）进行价值估算<sup>[24,25,26]</sup>；$s_x$为分析地块$x$的碳封存量，以吨（tons）计；$q$为未来的年份；$p$为当前的年份；$r$是碳价格的年度市场折价率（discount rate），反映了社会对眼前利益于未来利益的偏好，其值越低表明碳价格的波动越小，如果值为 0% 则碳的货币价值不折价。通常配置碳价格的年度市场折价率为一个较低值，例如美国政府推荐值为 7%，来表明影响气候变化的碳封存具有较高的社会经济价值；$c$是碳价格的年变化率。因为碳排放对气候变化的影响随时间的推移带来相关的损害变化，这将改变碳封存的社会价值，例如配置年变化率大于 0% 意味着未来封存碳的社会价值小于现在封存的碳的价值。为了减小未来气候变化（例如温度升高 $2 ^ \circ$）对全球经济造成的重大破坏，立即减少温室气体的排放是必要的，因此配置大于0的折价率表明减少碳排放，增加碳封存的重要性，以降低气候变化的风险。如果折价率配置小于 0%（例如 -2%） ，意味着未来碳封存的社会价值大于现在的碳封存价值。对应InVEST中的代码如下：

```python
def _calculate_valuation_constant(self,lulc_cur_year, lulc_fut_year, discount_rate, rate_change,price_per_metric_ton_of_c):
    """Calculate a net present valuation constant to multiply carbon storage.

    Args:
        lulc_cur_year (int): calendar year in present
        lulc_fut_year (int): calendar year in future
        discount_rate (float): annual discount rate as a percentage
        rate_change (float): annual change in price of carbon as a percentage
        price_per_metric_ton_of_c (float): currency amount of Mg of carbon

    Returns:
        a floating point number that can be used to multiply a delta carbon
        storage value by to calculate NPV.
    """
    n_years = lulc_fut_year - lulc_cur_year
    ratio = (
        1 / ((1 + discount_rate / 100) *
             (1 + rate_change / 100)))
    valuation_constant = (price_per_metric_ton_of_c / n_years)
    # note: the valuation formula in the user's guide uses sum notation.
    # here it's been simplified to remove the sum using the general rule
    # sum(r^k) from k=0 to N  ==  (r^(N+1) - 1) / (r - 1)
    # where N = n_years-1 and r = ratio
    if ratio == 1:
        # if ratio == 1, we would divide by zero in the equation below
        # so use the limit as ratio goes to 1, which is n_years
        valuation_constant *= n_years
    else:
        valuation_constant *= (1 - ratio ** n_years) / (1 - ratio)
    return valuation_constant    
```

将 InVEST 的碳储存和封存计算代码迁移至 `USDA`库调用计算。


```python
%load_ext autoreload 
%autoreload 2 
import warnings
warnings.filterwarnings('ignore')

from usda.migrated_project.invest.esv import u
import usda.migrated_project.invest as usda_esv
from usda.data_visualization import generate_colors,cmap_patch_build
import usda.data_visual as usda_vis

import pandas as pd
import rioxarray as rxr
import matplotlib.pyplot as plt
import matplotlib as mpl
import numpy as np
```

    The autoreload extension is already loaded. To reload it, use:
      %reload_ext autoreload
    

配置参数，包括计算产生的过程文件和最终文件的保存路径`workspace_dir`，碳库数据文件路径`carbon_pools_path`，线程数`n_workers`，结果文件的后缀`results_suffix`，LULC文件路径，包括当前（`results_suffix`）、未来（`lulc_fut_path`）和用于场景分析的REDD情景（`lulc_redd_path`），当前和未来LULC所属年份`lulc_cur_yea`和`lulc_fut_year`，折价率`discount_rate`，年变化率`'rate_change`和碳价格`price_per_metric_ton_of_c`等，可以通过`help(usda_esv.Carbon_storage_sequestration)`获得所有参数的说明。


```python
help(usda_esv.Carbon_storage_sequestration)
```

    Help on class Carbon_storage_sequestration in module usda.migrated_project.invest.esv._carbon:
    
    class Carbon_storage_sequestration(builtins.object)
     |  Carbon_storage_sequestration(args)
     |  
     |  Carbon.
     |  
     |  Calculate the amount of carbon stocks given a landscape, or the difference
     |  due to a future change, and/or the tradeoffs between that and a REDD
     |  scenario, and calculate economic valuation on those scenarios.
     |  
     |  The model can operate on a single scenario, a combined present and future
     |  scenario, as well as an additional REDD scenario.
     |  
     |  Args:
     |      args['workspace_dir'] (string): a path to the directory that will
     |          write output and other temporary files during calculation.
     |      args['results_suffix'] (string): appended to any output file name.
     |      args['lulc_cur_path'] (string): a path to a raster representing the
     |          current carbon stocks.
     |      args['calc_sequestration'] (bool): if true, sequestration should
     |          be calculated and 'lulc_fut_path' and 'do_redd' should be defined.
     |      args['lulc_fut_path'] (string): a path to a raster representing future
     |          landcover scenario.  Optional, but if present and well defined
     |          will trigger a sequestration calculation.
     |      args['do_redd'] ( bool): if true, REDD analysis should be calculated
     |          and 'lulc_redd_path' should be defined
     |      args['lulc_redd_path'] (string): a path to a raster representing the
     |          alternative REDD scenario which is only possible if the
     |          args['lulc_fut_path'] is present and well defined.
     |      args['carbon_pools_path'] (string): path to CSV or that indexes carbon
     |          storage density to lulc codes. (required if 'do_uncertainty' is
     |          false)
     |      args['lulc_cur_year'] (int/string): an integer representing the year
     |          of `args['lulc_cur_path']` used if `args['do_valuation']`
     |          is True.
     |      args['lulc_fut_year'](int/string): an integer representing the year
     |          of `args['lulc_fut_path']` used in valuation if it exists.
     |          Required if  `args['do_valuation']` is True and
     |          `args['lulc_fut_path']` is present and well defined.
     |      args['do_valuation'] (bool): if true then run the valuation model on
     |          available outputs. Calculate NPV for a future scenario or a REDD
     |          scenario and report in final HTML document.
     |      args['price_per_metric_ton_of_c'] (float): Is the present value of
     |          carbon per metric ton. Used if `args['do_valuation']` is present
     |          and True.
     |      args['discount_rate'] (float): Discount rate used if NPV calculations
     |          are required.  Used if `args['do_valuation']` is  present and
     |          True.
     |      args['rate_change'] (float): Annual rate of change in price of carbon
     |          as a percentage.  Used if `args['do_valuation']` is  present and
     |          True.
     |      args['n_workers'] (int): (optional) The number of worker processes to
     |          use for processing this model.  If omitted, computation will take
     |          place in the current process.
     |  
     |  Returns:
     |      None.
     |  
     |  Methods defined here:
     |  
     |  __init__(self, args)
     |      Initialize self.  See help(type(self)) for accurate signature.
     |  
     |  ----------------------------------------------------------------------
     |  Data descriptors defined here:
     |  
     |  __dict__
     |      dictionary for instance variables (if defined)
     |  
     |  __weakref__
     |      list of weak references to the object (if defined)
    
    


```python
args_carbon={
    'workspace_dir':'I:\ESVs\carbon',
    'carbon_pools_path':r'I:\data\invest\Carbon\carbon_pools_willamette.csv',
    'n_workers':6,
    'results_suffix':'willamette',
    'lulc_cur_path':r'I:\data\invest\Carbon\lulc_current_willamette.tif',
    'lulc_fut_path':r'I:\data\invest\Carbon\lulc_future_willamette.tif',
    'lulc_redd_path':r"I:\data\invest\Carbon\lulc_redd_willamette.tif",
    'do_valuation':True,
    'do_redd':True,
    'lulc_cur_year':2020,
    'lulc_fut_year':2050,
    'discount_rate':0.07,
    'rate_change':0.05,
    'price_per_metric_ton_of_c':80,
    }
```

碳库和 LULC 分类相对应，因此碳储存和封存的计算受到这两个数据及其相互牵制的影响。碳库数据通常使用已有研究测量结果，例如石羊河流域不同土地利用类型的碳密度（$t /hm^2$）<sup>[27]</sup>。

| 土地利用类型  | 地上碳密度（C_above）  | 地下碳密度（C_below）  | 土壤有机质（C_soil）  | 死亡有机质（C_soil）  |
|---|---|---|---|---|
| 耕地   | 5.7  | 80.7  | 108.4  | 13  |
| 林地  | 42.4  | 115.9  | 236.9  | 13  |
| 草地  | 35.3  | 86.5  | 99.9  | 2  |
| 水域 | 0  |  0 | 0  | 0  |
| 建筑用地  |1.2   | 0  | 0  | 0  |
| 未利用地  | 9.1  | 0  | 21.6  | 0  |

又或者[杨元合课题组发布青藏高原高寒草地土壤碳库及其动态变化专题数据](http://www.nesdc.org.cn/collection/view/6124789b7e28172cbed3d803)<sup>㉕</sup>等。

InVEST提供的威拉米特区域的碳库细分有102个类别，增加了碳储存和封存计算结果精度。该碳库为LULC类别的平均碳储存值，其理想数据源应为实地测量估算值。但是如果无法实现实地测量，可以使用一些通用的数据源，例如对于地上生物量中储存的碳 ，一个非常普遍使用的数据源是 IPCC于2006年制定的[国家温室气体清单指南（农业、森林和其它土地利用）](https://www.ipcc-nggip.iges.or.jp/public/2006gl/vol4.html)<sup>㉖</sup>。指南中的表格给出了多种土地利用类型地上生物量估算值，因为InVEST使用元素碳的质量，因此需要乘以一个转换系数将公吨的生物量转换为公吨的碳，该系数通常在0.43到0.51之间变化，可以从指南相关表格中查询；对于地下生物量中存储的碳，如果LULC主要为木质生物量（woody biomass），可以从指南中提供的根茎比（root to shoot）估算。但是如果LULC几乎不含木质生物量，却包含大量地下碳储量（例如草原灌丛等），通常需要本地测量数据。如果该数据不可获得，可从使用一些全球估算值，例如 IPCC 指南相关表格列出了每个气候区的总生物量（地上和地下）和地上生物量，可以同差值粗略估计地下生物量；对于土壤中存储的碳，指南中相应表格给出了按土壤类型划分的土壤碳储量估计值；储存在死亡有机物中的碳，指南中也给出了森林土地利用/覆盖类型中落叶的默认碳储量。对于非林地类型，枯落物接近为0。InVEST 也给出了其它一些碳库碳储存估算的[数据来源](https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/data_sources.html#belowground-biomass)<sup>㉗ </sup><sup>[28]</sup>。


```python
carbon_pools_willamette=pd.read_csv(args_carbon['carbon_pools_path'])
print(carbon_pools_willamette.to_string())
```

        lucode                                 LULC_Name  C_above  C_below  C_soil  C_dead
    0        1                Residential 0-4 units/acre       15       10      60     1.0
    1        2                Residential 4-9 units/acre        5        3      20     0.0
    2        3               Residential 9-16 units/acre        2        1       5     0.0
    3        4                Residential >16 units/acre        0        0       0     0.0
    4        5                                    Vacant       10       20      10     5.0
    5        6                                Commercial        0        0       0     0.0
    6        7                     Commercial/Industrial        0        0       0     0.0
    7        8                                Industrial        0        0       0     0.0
    8        9                   Industrial & Commercial        0        0       0     0.0
    9       10                  Residential & Commercial        0        0       0     0.0
    10      11               Urban non-vegetated unknown        0        0      10     0.0
    11      16                          Rural structures        0        0      50     0.0
    12      18                                  Railroad        0        0      25     0.0
    13      19                             Primary roads        0        0      50     0.0
    14      20                           Secondary roads        0        0      25     0.0
    15      21                          Light duty roads        0        0      35     0.0
    16      24               Rural non-vegetated unknown        0        0       0     0.0
    17      29                Main channel non-vegetated        0        0       0     0.0
    18      32                         Stream orders 5-7        0        0       0     0.0
    19      33                    Permanent lentic water        0        0       0     0.0
    20      39                        Topographic Shadow      100        5      65    50.0
    21      40                                      Snow        0        0       0     0.0
    22      42                                    Barren        0        0       0     0.0
    23      49                      Urban tree overstory      135       50      75     1.0
    24      51                        Upland Forest open       75       45      85    20.0
    25      52           Upland Forest Semi-closed mixed       90       60     110    30.0
    26      53                    Forest Closed hardwood      180      120     120    55.0
    27      54                       Forest Closed mixed      200      130     130    65.0
    28      55         Upland Forest Semi-closed conifer       90       60      95    29.0
    29      56                         Conifers 0-20 yrs       10        7      76     2.5
    30      57           Forest closed conifer 21-40 yrs       88       59      96    29.0
    31      58           Forest closed conifer 41-60 yrs      165      110     115    50.0
    32      59           Forest closed conifer 61-80 yrs      225      150     124    65.0
    33      60          Forest closed conifer 81-200 yrs      300      200     135    85.0
    34      61  Forest closed conifer older than 200 yrs      375      250     150   100.0
    35      62        Upland Forest Semi-closed hardwood       80       50     100    25.0
    36      66                             Hybrid poplar       75       25      90     2.0
    37      67                       Grass seed rotation        1        1      10     0.0
    38      68            Irrigated annual crop rotation        2        1      10     0.0
    39      71                                    Grains        3        2      10     0.0
    40      72                                   Nursery       10        3      90     1.0
    41      73                       Berries & Vineyards        8        5      20     0.0
    42      74                           Double cropping        5        2      10     0.0
    43      75                                      Hops        5        4      20     0.0
    44      76                                      Mint        2        1      10     0.0
    45      77                               Radish seed        2        1      10     0.0
    46      78                           Sugar beet seed        2        1      10     0.0
    47      79                                  Row crop        3        2      10     0.0
    48      80                                     Grass        1        1      10     0.0
    49      81                              Burned grass        0        1      10     0.0
    50      82                                Field crop        3        2       8     1.0
    51      83                                  Hayfield        5        4      23     1.0
    52      84                           Late field crop        5        3      15     0.0
    53      85                                   Pasture        5        4      25     1.0
    54      86                         Natural grassland        6        6      20     2.0
    55      87                             Natural shrub        8        8      25     3.0
    56      88                               Bare/fallow        1        1      10     0.0
    57      89                             Flooded/marsh       10        5      20     0.0
    58      90                       Irrigated perennial        5        5      15     0.0
    59      91                                 Turfgrass        1        1      10     0.0
    60      92                                   Orchard      125        5     115     1.0
    61      93                           Christmas trees       13       28      95     2.0
    62      95                           Conifer Woodlot      275       30      95    10.0
    63      98                               Oak savanna      100       20     115    50.0
    64     101                                 Wet shrub        7        3      25     0.0
    65     102                                   Unknown        0        0       0     0.0
    

查看当前、未来和REDD情景的 LULC 数据。

> 在打印地图时，随机配置了 LULC分类颜色。


```python
lulc_cur=rxr.open_rasterio(args_carbon['lulc_cur_path'],masked=True).squeeze()
lulc_fut=rxr.open_rasterio(args_carbon['lulc_fut_path'],masked=True).squeeze()
lulc_redd=rxr.open_rasterio(args_carbon['lulc_redd_path'],masked=True).squeeze()

print(lulc_cur.rio.crs)
lulc_cur
```

    EPSG:26910
    




<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (y: 1889, x: 1325)&gt;
[2502925 values with dtype=float32]
Coordinates:
    band         int32 1
  * x            (x) float64 4.437e+05 4.438e+05 ... 4.834e+05 4.835e+05
  * y            (y) float64 4.957e+06 4.957e+06 4.956e+06 ... 4.9e+06 4.9e+06
    spatial_ref  int32 0
Attributes: (12/13)
    AREA_OR_POINT:             Area
    DataType:                  Generic
    RepresentationType:        THEMATIC
    STATISTICS_COVARIANCES:    294.9522998374362
    STATISTICS_MAXIMUM:        95
    STATISTICS_MEAN:           62.352993778709
    ...                        ...
    STATISTICS_SKIPFACTORX:    1
    STATISTICS_SKIPFACTORY:    1
    STATISTICS_STDDEV:         17.174170144902
    STATISTICS_VALID_PERCENT:  65.59
    scale_factor:              1.0
    add_offset:                0.0</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'></div><ul class='xr-dim-list'><li><span class='xr-has-index'>y</span>: 1889</li><li><span class='xr-has-index'>x</span>: 1325</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-ccb33f70-02ae-4f51-9300-1deb5cfee02d' class='xr-array-in' type='checkbox' checked><label for='section-ccb33f70-02ae-4f51-9300-1deb5cfee02d' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>...</span></div><div class='xr-array-data'><pre>[2502925 values with dtype=float32]</pre></div></div></li><li class='xr-section-item'><input id='section-98aaf0fb-b5be-4c9c-95cb-d691dc360227' class='xr-section-summary-in' type='checkbox'  checked><label for='section-98aaf0fb-b5be-4c9c-95cb-d691dc360227' class='xr-section-summary' >Coordinates: <span>(4)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>band</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>int32</div><div class='xr-var-preview xr-preview'>1</div><input id='attrs-a5a63dff-60e1-48f0-bd6b-3fec51f1c558' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-a5a63dff-60e1-48f0-bd6b-3fec51f1c558' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-152a4701-7a8a-411c-a12e-caea92b91b04' class='xr-var-data-in' type='checkbox'><label for='data-152a4701-7a8a-411c-a12e-caea92b91b04' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array(1)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>x</span></div><div class='xr-var-dims'>(x)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>4.437e+05 4.438e+05 ... 4.835e+05</div><input id='attrs-08900f08-3a29-4eb9-bbc5-28c0f7cb1d8b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-08900f08-3a29-4eb9-bbc5-28c0f7cb1d8b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-9ce128cf-10de-4906-b37a-7979ddebdce9' class='xr-var-data-in' type='checkbox'><label for='data-9ce128cf-10de-4906-b37a-7979ddebdce9' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([ 443738.127328,  443768.127328,  443798.127328, ...,  483398.127328,
        483428.127328,  483458.127328])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>y</span></div><div class='xr-var-dims'>(y)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>4.957e+06 4.957e+06 ... 4.9e+06</div><input id='attrs-b5e4c843-285a-4b7e-94ed-17bb236f9448' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-b5e4c843-285a-4b7e-94ed-17bb236f9448' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-25636a42-8c03-4790-8bbd-83c543c8cb0d' class='xr-var-data-in' type='checkbox'><label for='data-25636a42-8c03-4790-8bbd-83c543c8cb0d' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([ 4956531.90598,  4956501.90598,  4956471.90598, ...,  4899951.90598,
        4899921.90598,  4899891.90598])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>spatial_ref</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>int32</div><div class='xr-var-preview xr-preview'>0</div><input id='attrs-b0661eb2-b025-4e47-ba88-658495fecdf3' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-b0661eb2-b025-4e47-ba88-658495fecdf3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-cc65c693-06a3-4ab5-a0f5-a2f71af593eb' class='xr-var-data-in' type='checkbox'><label for='data-cc65c693-06a3-4ab5-a0f5-a2f71af593eb' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>crs_wkt :</span></dt><dd>PROJCS[&quot;NAD83 / UTM zone 10N&quot;,GEOGCS[&quot;NAD83&quot;,DATUM[&quot;North_American_Datum_1983&quot;,SPHEROID[&quot;GRS 1980&quot;,6378137,298.257222101004,AUTHORITY[&quot;EPSG&quot;,&quot;7019&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;6269&quot;]],PRIMEM[&quot;Greenwich&quot;,0],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4269&quot;]],PROJECTION[&quot;Transverse_Mercator&quot;],PARAMETER[&quot;latitude_of_origin&quot;,0],PARAMETER[&quot;central_meridian&quot;,-123],PARAMETER[&quot;scale_factor&quot;,0.9996],PARAMETER[&quot;false_easting&quot;,500000],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;metre&quot;,1,AUTHORITY[&quot;EPSG&quot;,&quot;9001&quot;]],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH],AUTHORITY[&quot;EPSG&quot;,&quot;26910&quot;]]</dd><dt><span>semi_major_axis :</span></dt><dd>6378137.0</dd><dt><span>semi_minor_axis :</span></dt><dd>6356752.314140356</dd><dt><span>inverse_flattening :</span></dt><dd>298.257222101004</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>GRS 1980</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>NAD83</dd><dt><span>horizontal_datum_name :</span></dt><dd>North American Datum 1983</dd><dt><span>projected_crs_name :</span></dt><dd>NAD83 / UTM zone 10N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>-123.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS[&quot;NAD83 / UTM zone 10N&quot;,GEOGCS[&quot;NAD83&quot;,DATUM[&quot;North_American_Datum_1983&quot;,SPHEROID[&quot;GRS 1980&quot;,6378137,298.257222101004,AUTHORITY[&quot;EPSG&quot;,&quot;7019&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;6269&quot;]],PRIMEM[&quot;Greenwich&quot;,0],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4269&quot;]],PROJECTION[&quot;Transverse_Mercator&quot;],PARAMETER[&quot;latitude_of_origin&quot;,0],PARAMETER[&quot;central_meridian&quot;,-123],PARAMETER[&quot;scale_factor&quot;,0.9996],PARAMETER[&quot;false_easting&quot;,500000],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;metre&quot;,1,AUTHORITY[&quot;EPSG&quot;,&quot;9001&quot;]],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH],AUTHORITY[&quot;EPSG&quot;,&quot;26910&quot;]]</dd><dt><span>GeoTransform :</span></dt><dd>443723.1273278779 30.0 0.0 4956546.905980413 0.0 -30.0</dd></dl></div><div class='xr-var-data'><pre>array(0)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-5dd58f1c-2358-438b-9d49-4dd4fb67baf0' class='xr-section-summary-in' type='checkbox'  ><label for='section-5dd58f1c-2358-438b-9d49-4dd4fb67baf0' class='xr-section-summary' >Indexes: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>x</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-2da49d41-9610-4f91-b2d0-7e8b0af17ccf' class='xr-index-data-in' type='checkbox'/><label for='index-2da49d41-9610-4f91-b2d0-7e8b0af17ccf' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([443738.1273278779, 443768.1273278779, 443798.1273278779,
              443828.1273278779, 443858.1273278779, 443888.1273278779,
              443918.1273278779, 443948.1273278779, 443978.1273278779,
              444008.1273278779,
              ...
              483188.1273278779, 483218.1273278779, 483248.1273278779,
              483278.1273278779, 483308.1273278779, 483338.1273278779,
              483368.1273278779, 483398.1273278779, 483428.1273278779,
              483458.1273278779],
             dtype=&#x27;float64&#x27;, name=&#x27;x&#x27;, length=1325))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>y</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-a7c96e87-c0ee-4caa-b51f-f964cbf9b7ed' class='xr-index-data-in' type='checkbox'/><label for='index-a7c96e87-c0ee-4caa-b51f-f964cbf9b7ed' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([4956531.905980413, 4956501.905980413, 4956471.905980413,
              4956441.905980413, 4956411.905980413, 4956381.905980413,
              4956351.905980413, 4956321.905980413, 4956291.905980413,
              4956261.905980413,
              ...
              4900161.905980413, 4900131.905980413, 4900101.905980413,
              4900071.905980413, 4900041.905980413, 4900011.905980413,
              4899981.905980413, 4899951.905980413, 4899921.905980413,
              4899891.905980413],
             dtype=&#x27;float64&#x27;, name=&#x27;y&#x27;, length=1889))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-458e8a4e-e206-430a-9f9b-2d4bb760af7f' class='xr-section-summary-in' type='checkbox'  ><label for='section-458e8a4e-e206-430a-9f9b-2d4bb760af7f' class='xr-section-summary' >Attributes: <span>(13)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>AREA_OR_POINT :</span></dt><dd>Area</dd><dt><span>DataType :</span></dt><dd>Generic</dd><dt><span>RepresentationType :</span></dt><dd>THEMATIC</dd><dt><span>STATISTICS_COVARIANCES :</span></dt><dd>294.9522998374362</dd><dt><span>STATISTICS_MAXIMUM :</span></dt><dd>95</dd><dt><span>STATISTICS_MEAN :</span></dt><dd>62.352993778709</dd><dt><span>STATISTICS_MINIMUM :</span></dt><dd>1</dd><dt><span>STATISTICS_SKIPFACTORX :</span></dt><dd>1</dd><dt><span>STATISTICS_SKIPFACTORY :</span></dt><dd>1</dd><dt><span>STATISTICS_STDDEV :</span></dt><dd>17.174170144902</dd><dt><span>STATISTICS_VALID_PERCENT :</span></dt><dd>65.59</dd><dt><span>scale_factor :</span></dt><dd>1.0</dd><dt><span>add_offset :</span></dt><dd>0.0</dd></dl></div></li></ul></div></div>




```python
hex_colors_only,_,_=generate_colors()
labels_cmap_dict=dict(zip(carbon_pools_willamette.lucode,carbon_pools_willamette.LULC_Name))
labels_cmap_dict={k:[v,hex_colors_only[k]] for k,v in labels_cmap_dict.items()}
cmap_LC,norm,patches=cmap_patch_build(labels_cmap_dict,)
cmap_LC
```


<img src="./imgs/3_5_c/output_18_0.png" height='auto' width='auto' title="caDesign">



```python
f, axes=plt.subplots(1,3,figsize=(20,6))
lulc_cur.plot.imshow(ax=axes[0],add_colorbar=False,cmap=cmap_LC,norm=norm)
lulc_fut.plot.imshow(ax=axes[1],add_colorbar=False,cmap=cmap_LC,norm=norm)
lulc_redd.plot.imshow(ax=axes[2],add_colorbar=False,cmap=cmap_LC,norm=norm)

axes[0].set_title('Current LULC')
axes[1].set_title('Future LULC')
axes[2].set_title('REDD LULC')
for ax in axes: ax.tick_params(axis='x', labelrotation=90)
plt.show()
```


<img src="./imgs/3_5_c/output_19_0.png" height='auto' width='auto' title="caDesign">    


调用`usda_esv.Carbon_storage_sequestration()`方法计算碳储存和封存。为了方便查看结果数据和进行后续计算，在迁移InVEST代码时，增加了`carbon_results_info`属性，用于存储过程文件和结果文件保存路径。结果文件中，

`tot_c_cur_[Suffix].tif/tot_c_fut_[Suffix].tif/tot_c_redd_[Suffix].tif`格式栅格文件为当前、未来和REDD方案每个像素（案例为$30 \times 30m$）存储的碳量（碳储存）；

`delta_cur_fut_[Suffix].tif/delta_cur_redd_[Suffix].tif`为未来/REDD景观与当前景观之间的碳储存差异（封存），以公吨/像素（栅格单元）为单位。如果值为正则为封存的碳，如果为负值则表示有碳流失；

`npv_fut_[Suffix].tif/npv_redd_[Suffix].tif`为未来/REDD景观与当前景观之间的碳封存的社会经济价值（货币化），单位是货币/像素（栅格单元）。


```python
carbon=usda_esv.Carbon_storage_sequestration(args_carbon)
carbon.carbon_results_info['tifs_to_summarize']
```

    cell size set={(30.0, -30.0)};
    raster size set={(1325, 1889)};
    valid lulc keys=['lulc_cur_path', 'lulc_fut_path', 'lulc_redd_path']
    valid scenarios=['cur', 'fut', 'redd']
    




    {'I:\\ESVs\\carbon\\delta_cur_fut_willamette.tif',
     'I:\\ESVs\\carbon\\delta_cur_redd_willamette.tif',
     'I:\\ESVs\\carbon\\npv_fut_willamette.tif',
     'I:\\ESVs\\carbon\\npv_redd_willamette.tif',
     'I:\\ESVs\\carbon\\tot_c_cur_willamette.tif',
     'I:\\ESVs\\carbon\\tot_c_fut_willamette.tif',
     'I:\\ESVs\\carbon\\tot_c_redd_willamette.tif'}



* 打印查看各时期和规划情景（REDD）下的碳储存


```python
tot_c_cur_willamette=rxr.open_rasterio(r'I:\\ESVs\\carbon\\tot_c_cur_willamette.tif',masked=True).squeeze()
tot_c_fut_willamette=rxr.open_rasterio(r'I:\\ESVs\\carbon\\tot_c_fut_willamette.tif',masked=True).squeeze()
tot_c_redd_willamette=rxr.open_rasterio(r'I:\\ESVs\\carbon\\tot_c_redd_willamette.tif',masked=True).squeeze()

f, axes=plt.subplots(1,3,figsize=(20,6))
cmap='jet'
tot_c_cur_willamette.plot.imshow(ax=axes[0],add_colorbar=False,cmap=cmap)
tot_c_fut_willamette.plot.imshow(ax=axes[1],add_colorbar=False,cmap=cmap)
ax=tot_c_redd_willamette.plot.imshow(ax=axes[2],add_colorbar=False,cmap=cmap)

axes[0].set_title('tot_c_cur_willamette')
axes[1].set_title('tot_c_fut_willamette')
axes[2].set_title('tot_c_redd_willamette')

cax,kw = mpl.colorbar.make_axes([ax for ax in axes.flat])
plt.colorbar(ax, cax=cax, **kw)
plt.show()
```


<img src="./imgs/3_5_c/output_23_0.png" height='auto' width='auto' title="caDesign">    


* 打印查看碳封存


```python
delta_cur_fut_willamette=rxr.open_rasterio(r'I:\\ESVs\\carbon\\delta_cur_fut_willamette.tif',masked=True).squeeze()
delta_cur_redd_willamette=rxr.open_rasterio(r'I:\\ESVs\\carbon\\delta_cur_redd_willamette.tif',masked=True).squeeze()

f, axes=plt.subplots(1,2,figsize=(13,5))
cmap='jet'
delta_cur_fut_willamette.plot.imshow(ax=axes[0],add_colorbar=False,cmap=cmap)
ax=delta_cur_redd_willamette.plot.imshow(ax=axes[1],add_colorbar=False,cmap=cmap)

axes[0].set_title('delta_cur_fut_willamette')
axes[1].set_title('delta_cur_redd_willamette')

cax,kw = mpl.colorbar.make_axes([ax for ax in axes.flat])
plt.colorbar(ax, cax=cax, **kw)
plt.show()
```

<img src="./imgs/3_5_c/output_25_0.png" height='auto' width='auto' title="caDesign">
    


* 打印查看碳封存的经济价值


```python
npv_fut_willamette=rxr.open_rasterio(r'I:\\ESVs\\carbon\\npv_fut_willamette.tif',masked=True).squeeze()
npv_redd_willamette=rxr.open_rasterio(r'I:\\ESVs\\carbon\\npv_redd_willamette.tif',masked=True).squeeze()

f, axes=plt.subplots(1,2,figsize=(13,5))
cmap='jet'
npv_fut_willamette.plot.imshow(ax=axes[0],add_colorbar=False,cmap=cmap)
ax=npv_redd_willamette.plot.imshow(ax=axes[1],add_colorbar=False,cmap=cmap)

axes[0].set_title('npv_fut_willamette')
axes[1].set_title('npv_redd_willamette')

cax,kw = mpl.colorbar.make_axes([ax for ax in axes.flat])
plt.colorbar(ax, cax=cax, **kw)
plt.show()
```

<img src="./imgs/3_5_c/output_27_0.png" height='auto' width='auto' title="caDesign">
    


## 3.5.3 生境质量（Habitat Quality）、 作物授粉（授粉者丰度）（Crop Pollination (Pollinator Abundance)）和作物生产（Crop Production）

### 3.5.3.1 生境质量（Habitat Quality）<sup>[29]</sup>
   
#### 1) 生境适宜性数值配置
    
InVEST 生境质量模型首先需要确定 LULC 数据中哪些类型应被考虑为生境，这可以用简单的二分法，值1表示为生境，而值0表示为非生境。二分法并不体现生境的重要性、稀有性或适宜性，所有生境类型均为值1，表征为平等的关系。模型的输入也假设不针对任何特定的物种，而是适用于更一般的生物多样性；如果要考虑生境的重要性、稀有性或适宜性，则值的配置为从0至1的一个连续值，1表示最高的生境适宜性。值越低则表示该 LULC 类型越不适宜于生物生存。对应 LULC 类型的生境（适宜性）配置，位于案例数据文件`sensitivity_willamette.csv`下的`HABITAT`字段，如下代码（为二分法）。用（$H_j$）表示 LULC 类型$j$的生境适宜性。


```python
args_habitat_quality={
        'workspace_dir':'I:\ESVs\habitat_quality',   
        'n_workers':6,
        'results_suffix':'willamette',     
        'threats_table_path':r'I:\data\invest\HabitatQuality\threats_willamette.csv',
        'sensitivity_table_path':r'I:\data\invest\HabitatQuality\sensitivity_willamette.csv',
        'half_saturation_constant':0.05,
        'lulc_cur_path':r'I:\data\invest\HabitatQuality\lulc_current_willamette.tif',
        'lulc_fut_path':r'I:\data\invest\HabitatQuality\lulc_future_willamette.tif',
        'lulc_bas_path':r'I:\data\invest\HabitatQuality\lulc_baseline_willamette.tif',
        'access_vector_path':r'I:\data\invest\HabitatQuality\accessibility_willamette.shp',        
        }
```

* 现状土地覆盖（Current Land Cover）


```python
lulc_cur=rxr.open_rasterio(args_habitat_quality['lulc_cur_path'],masked=True).squeeze()
print(lulc_cur.rio.crs)
```

    EPSG:26910
    


```python
f, ax=plt.subplots(1,1,figsize=(20,10))
lulc_cur.plot.imshow(ax=ax,add_colorbar=False,cmap=cmap_LC,norm=norm)

ax.set_title('Current LULC')
plt.show()
```

<img src="./imgs/3_5_c/output_32_0.png" height='auto' width='auto' title="caDesign">   


* 敏感性表格（Sensitivity Table）


```python
sensitivity_table=pd.read_csv(args_habitat_quality['sensitivity_table_path'])
print(sensitivity_table.to_string())
```

        LULC                                NAME  HABITAT  crops  railroad  urban  timber  roads1  roads2  roads3
    0      1          Residential 0-4 units/acre        1    0.4      0.45    0.6     0.2     0.4     0.3     0.2
    1      2          Residential 4-9 units/acre        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    2      3         Residential 9-16 units/acre        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    3      4          Residential >16 units/acre        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    4      6                          Commercial        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    5      7               Commercial/Industrial        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    6      8                          Industrial        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    7     10                          Industrial        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    8     11         Urban non-vegetated unknown        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    9     16                    Rural structures        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    10    18                            Railroad        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    11    19                       Primary roads        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    12    20                     Secondary roads        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    13    21                    Light duty roads        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    14    24         Rural non-vegetated unknown        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    15    29          Main channel non-vegetated        1    0.7      0.75    0.9     0.5     0.7     0.6     0.5
    16    32                   Stream orders 5-7        1    0.7      0.75    0.9     0.5     0.7     0.6     0.5
    17    33              Permanent lentic water        1    0.7      0.75    0.9     0.5     0.7     0.6     0.5
    18    39                  Topographic Shadow        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    19    40                                Snow        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    20    42                              Barren        0    0.0      0.00    0.0     0.0     0.0     0.0     0.0
    21    49                Urban tree overstory        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    22    51                  Upland Forest open        1    0.8      0.85    1.0     0.6     0.8     0.7     0.6
    23    52     Upland Forest Semi-closed mixed        1    0.7      0.75    0.9     0.5     0.7     0.6     0.5
    24    53              Forest Closed hardwood        1    0.6      0.65    0.8     0.4     0.6     0.5     0.4
    25    54                 Forest Closed mixed        1    0.6      0.65    0.8     0.4     0.6     0.5     0.4
    26    55   Upland Forest Semi-closed conifer        1    0.7      0.75    0.9     0.5     0.7     0.6     0.5
    27    56                   Conifers 0-20 yrs        1    0.5      0.55    0.7     0.3     0.5     0.4     0.3
    28    57     Forest closed conifer 21-40 yrs        1    0.5      0.55    0.7     0.3     0.5     0.4     0.3
    29    58     Forest closed conifer 41-60 yrs        1    0.5      0.55    0.7     0.3     0.5     0.4     0.3
    30    59     Forest closed conifer 61-80 yrs        1    0.6      0.65    0.8     0.4     0.6     0.5     0.4
    31    60    Forest closed conifer 81-200 yrs        1    1.0      1.00    1.0     0.8     1.0     0.9     0.8
    32    61     Forest closed conifer > 200 yrs        1    1.0      1.00    1.0     0.8     1.0     0.9     0.8
    33    62  Upland Forest Semi-closed hardwood        1    0.7      0.75    0.9     0.5     0.7     0.6     0.5
    34    66                       Hybrid poplar        1    0.5      0.55    0.7     0.3     0.5     0.4     0.3
    35    67                 Grass seed rotation        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    36    68           Irrigated annual rotation        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    37    71                              Grains        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    38    72                             Nursery        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    39    73                 Berries & Vineyards        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    40    74                     Double cropping        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    41    75                                Hops        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    42    76                                Mint        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    43    77                         Radish seed        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    44    78                     Sugar beet seed        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    45    79                            Row crop        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    46    80                               Grass        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    47    81                        Burned grass        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    48    82                          Field crop        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    49    83                            Hayfield        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    50    84                     Late field crop        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    51    85                             Pasture        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    52    86                   Natural grassland        1    0.4      0.45    0.6     0.2     0.4     0.3     0.2
    53    87                       Natural shrub        1    0.4      0.45    0.6     0.2     0.4     0.3     0.2
    54    88                         Bare/fallow        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    55    89                       Flooded/marsh        1    0.7      0.75    0.9     0.5     0.7     0.6     0.5
    56    91                 Irrigated perennial        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    57    90                           Turfgrass        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    58    92                             Orchard        1    0.3      0.35    0.5     0.1     0.3     0.2     0.1
    59    93                     Christmas trees        1    0.5      0.55    0.7     0.3     0.5     0.4     0.3
    60    95                     Conifer Woodlot        1    0.5      0.55    0.7     0.3     0.5     0.4     0.3
    

#### 2）生境威胁密度（habitat threat density，HTD）数据及其对生境质量的影响

威胁对生境质量影响的数据位于`threats_willamette.csv`配置文件下，其中`THREAT`为威胁类型，`DESCRIP`字段为对威胁类型的描述，案例文件包括农业用地、建成区、木材采伐/种植园、铁路和三种类型的道路（一、二级公路和乡村公路）。每个威胁类型对应有现状和未来的栅格文件，用`CUR_PATH`和`FUT_PATH`字段指定栅格文件名（栅格文件和.csv配置文件位于同一路径下），用于模型计算时调用。字段`MAX_DIST`是威胁的最大作用距离。`WEIGHT`是威胁的影响权重，表示为$w_r$，值越趋近于1，对生境的相对破坏性也越大。


```python
threats_table=pd.read_csv(args_habitat_quality['threats_table_path'])
print(threats_table.to_string())
```

       MAX_DIST  WEIGHT    THREAT        DECAY                        DESCRIP  BASE_PATH        CUR_PATH        FUT_PATH
    0       8.0     0.7     crops       linear             Agricultural lands        NaN     crops_c.tif     crops_f.tif
    1       5.0     0.6  railroad  exponential                 Railroad lines        NaN  railroad_c.tif  railroad_f.tif
    2      10.0     1.0     urban  exponential                Urban/developed        NaN     urban_c.tif     urban_f.tif
    3       6.0     0.5    timber  exponential  Timber harvesting/Plantations        NaN    timber_c.tif    timber_f.tif
    4       3.0     1.0    roads1       linear                  Primary roads        NaN    roads1_c.tif    roads1_f.tif
    5       1.0     0.7    roads2       linear                Secondary roads        NaN    roads2_c.tif    roads2_f.tif
    6       0.5     0.5    roads3  exponential                    Rural roads        NaN    roads3_c.tif    roads3_f.tif
    

* 建成区威胁栅格数据示例

威胁地图（生境威胁密度）可以表示威胁强度，也可以只是用值1表示威胁的分布（没有威胁的区域用值0表示）。威胁地图栅格单元$y$的威胁数值表示为$r_y$。


```python
Urban=rxr.open_rasterio(r'I:\data\invest\HabitatQuality\urban_c.tif',masked=True).squeeze()
print(np.unique(Urban.data))

f, ax=plt.subplots(1,1,figsize=(20,10))
Urban.plot.imshow(ax=ax,add_colorbar=False)

plt.show()
```

    [0. 1.]
    

<img src="./imgs/3_5_c/output_38_1.png" height='auto' width='auto' title="caDesign">



生境的栅格单元与威胁的栅格单元之间距离的远近，影响生境质量。通常随着距离的增加，威胁对生境的影响逐渐减弱，为了表征这种影响关系，可以使用线性函数或指数函数作为距离衰减函数（distance-decay function）计算威胁影响系数$i_{rxy}$。其公式为：$i_{rxy}=1-\left( \frac{d_{xy}}{d_{r\ \mathrm{max}}}\right)\ \mathrm{if\ linear} \\ i_{rxy}=exp\left(-\left(\frac{2.99}{d_{r\ \mathrm{max}}}\right)d_{xy}\right)\mathrm{if\ exponential}$，式中，$d_{xy}$为栅格单元$x$与威胁$y$之间的直线距离，该距离的计算使用[pygeoprocessin库](https://pygeoprocessing.readthedocs.io/en/latest/api/pygeoprocessing.html#pygeoprocessing.distance_transform_edt)<sup>㉘</sup>的`distance_transform_edt`方法<sup>[30]</sup>；$d_{r\ \mathrm{max}}$为威胁的最大作用距离，即`MAX_DIST`字段值。为了方便观察距离衰减函数的变化趋势，打印图表如下。


```python
fig, ax=plt.subplots(1, 1,figsize=(10,5))
    
X=np.arange(0, 10000+10, 10)
d_max=5000

y_linear=[1-(x/d_max) if x<=d_max else 0 for x in X]
ax.plot(X,y_linear,label='linear')

y_exponential=[np.exp(-(2.99/d_max)*x) if x<=d_max else 0 for x in X]
ax.plot(X,y_exponential,label='exponential')

usda_vis.plot_style_axis_A(ax)
plt.legend(loc='upper right',frameon=False)
plt.show()
```


<img src="./imgs/3_5_c/output_40_0.png" height='auto' width='auto' title="caDesign">    


#### 3）可达性（accessibility）

如果限制进入生境区域，例如为生态保护区，或者人类无法接近的高海拔区域，那么威胁对生境的影响将会得到缓解。为了表达这一影响因素，绘制`accessibility_willamette.shp`矢量地图（SHP 数据格式），其值域为$\beta_x \in [0,1]$。值1表示为完全可进入性，值趋近于0则表示可达性逐渐降低。案例给出的可达性文件包含4个区域，可达性为0.2、0.8和1。


```python
args_habitat_quality=gpd.read_file(args_habitat_quality['access_vector_path'])
args_habitat_quality.plot(column='ACCESS',legend=True);
args_habitat_quality
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FID</th>
      <th>ACCESS</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0.2</td>
      <td>MULTIPOLYGON (((469563.515 4932894.663, 469559...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0.8</td>
      <td>MULTIPOLYGON (((484322.863 4951233.698, 484346...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1.0</td>
      <td>MULTIPOLYGON (((515669.675 4926249.355, 515671...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>1.0</td>
      <td>MULTIPOLYGON (((475648.118 4942540.232, 475644...</td>
    </tr>
  </tbody>
</table>
</div>




<img src="./imgs/3_5_c/output_42_1.png" height='auto' width='auto' title="caDesign">    


#### 4）生境类型对每一威胁的相对敏感性（relative sensitivity）

敏感性数据位于`sensitivity_willamette.csv`数据文件中，为前文的`sensitivity_table`变量值。每一种生境类型对威胁的敏感性可能不同，因此通过配置该值来修正威胁对生境的影响，其值域为$S_{jr} \in [0,1]$，式中，$j$代表 LULC 类型（生境类型），$r$代表某类威胁。为了更直观的观察生境类型对每一威胁的相对敏感性，使用热力图的方式图示数值强弱。


```python
cols=['NAME','HABITAT','crops','railroad','urban','timber','roads1','roads2','roads3']
data=sensitivity_table[cols].melt('NAME', value_name='vals')
data_pivot=data.pivot_table(index='NAME', columns='variable', values='vals',aggfunc='mean') # data_pivot=data.pivot(index='NAME', columns='variable', values='vals')

f, ax=plt.subplots(figsize=(20, 20))
sns.heatmap(data_pivot, annot=True, linewidths=.5, ax=ax);
```


<img src="./imgs/3_5_c/output_44_0.png" height='auto' width='auto' title="caDesign">    


基于以上4个因素，计算为 LULC 或生境类型$j$栅格单元$x$的总威胁水平（total threat level）$D_{xj}$，公式为$D_{xj}=\sum^R_{r=1}\sum^{Y_r}_{y=1}\left(\frac{w_r}{\sum^R_{r=1}w_r}\right)r_y i_{rxy} \beta_x S_{jr}$，式中，$y$索引威胁地图上的所有栅格单元。威胁权重为归一化的权重，通过$\frac{w_r}{\sum^R_{r=1}w_r}$方式计算。通过上述公式计算生境威胁水平得分后，可以由半饱和函数（half saturation function）转化为生境质量分值，其公式为：$Q_{xj} = H_j\left(1-\left(\frac{D^z_{xj}}{D^z_{xj}+k^z}\right)\right)$，式中，$z$和$k$为缩放参数（或常数），可参考配置$z=2.5$，$k=0.05$。当生境适宜性$H_j=0$时，生境质量为0。生境质量$Q_{xj}$随$H_j$的增加而增加，随$D_{xj}$的增加而减小，且$Q_{xj}$值永不会大于1。

下述代码打印了半饱和函数变化曲线，即当$D_{xj}$值增加时，$Q_{xj}$值的变化。


```python
z=2.5
k=0.05
fig, ax=plt.subplots(1, 1,figsize=(5,5))
    
X=np.arange(0, 1+0.01, 0.01)
ax.plot(X,1*(1-X**z/(X**z+k**z)))

usda_vis.plot_style_axis_A(ax)
plt.xlabel('$D_{xj}$', fontsize=15)
plt.ylabel('$Q_{xj}$', fontsize=15)
plt.show()
```


<img src="./imgs/3_5_c/output_46_0.png" height='auto' width='auto' title="caDesign">    


#### 生境稀有性（Habitat Rarity）

生境稀有性$R_j$的计算公式为$R_j=1-\frac{N_j}{N_{j_\mathrm{baseline}}+N_j}$，式中，$N_j$为当前 LULC 的第$j$个类别的面积；$N_{j_\mathrm{baseline}}$为过去（基准，baseline）LULC 第$j$个类别的面积。当$R$值越趋近于1，说明第$j$类生境（LULC）相对于基准生境的面积有大幅度减少，那么对于该类生境的保护可能需要增加重视。通过计算所有生境类型的$R_j$后，可以获得总的生境稀有性，公式为$R_x=\sum^X_{x=1}\sigma_{xj}R_j$，式中，如果栅格单元$x$落入第$j$类生境内，则$\sigma_{xj}=1$，并入和计算，否则为$\sigma_{xj}=0$，不计入。

迁移InVEST 生境质量计算模型至`USDA`库，计算结果如下。


```python
habitat_quality=usda_esv.Habitat_quality(args_habitat_quality)
habitat_quality.habitat_quality_results_info['paths_dict']
```

    The threat raster for crops could not be found for the land cover _b. Skipping Habitat Quality calculation for this land cover.
    




    {'degsum': ['I:\\ESVs\\habitat_quality\\deg_sum_c_willamette.tif',
      'I:\\ESVs\\habitat_quality\\deg_sum_f_willamette.tif'],
     'quality': ['I:\\ESVs\\habitat_quality\\quality_c_willamette.tif',
      'I:\\ESVs\\habitat_quality\\quality_f_willamette.tif'],
     'rarily': ['I:\\ESVs\\habitat_quality\\rarity_c_willamette.tif',
      'I:\\ESVs\\habitat_quality\\rarity_f_willamette.tif']}



读取和打印查看当前和未来景观的生境质量。


```python
quality_c_willamette=rxr.open_rasterio(r'I:\ESVs\habitat_quality\quality_c_willamette.tif',masked=True).squeeze()
quality_f_willamette=rxr.open_rasterio(r'I:\ESVs\habitat_quality\quality_f_willamette.tif',masked=True).squeeze()

f, axes=plt.subplots(1,2,figsize=(20,5))
cmap='gist_ncar'
quality_c_willamette.plot.imshow(ax=axes[0],add_colorbar=False,cmap=cmap)
ax=quality_f_willamette.plot.imshow(ax=axes[1],add_colorbar=False,cmap=cmap)

axes[0].set_title('quality_c_willamette')
axes[1].set_title('quality_f_willamette')

cax,kw = mpl.colorbar.make_axes([ax for ax in axes.flat])
plt.colorbar(ax, cax=cax, **kw)
plt.show()
```


<img src="./imgs/3_5_c/output_51_0.png" height='auto' width='auto' title="caDesign">    


### 3.5.3.2 作物授粉（授粉者丰度）（Crop Pollination (Pollinator Abundance)）<sup>[31]</sup>和作物生产（Crop Production）<sup>[32]</sup>
   
#### 1）作物授粉    
    
对作物授粉的解释，可以查看 InVEST 用户指南，这里同样将该模型迁移至`USDA`库，调用计算如下。


```python
args_crop_pollination={
    'workspace_dir':r'I:\ESVs\pollination',
    'results_suffix':'willamette',
    'n_workers':6,    
    'landcover_raster_path':r'I:\data\invest\pollination\landcover.tif',
    'guild_table_path':r'I:\data\invest\pollination\guild_table.csv',
    'landcover_biophysical_table_path':r'I:\data\invest\pollination\landcover_biophysical_table.csv',
    'farm_vector_path':r'I:\data\invest\pollination\farms.shp',
    }

crop_pollination=usda_esv.Crop_pollination(args_crop_pollination)        
```

读取打印地图查看春夏季节每个栅格所有物种的总授粉者丰度。


```python
total_pollinator_abundance_spring_willamette=rxr.open_rasterio(r'I:\ESVs\pollination\total_pollinator_abundance_spring_willamette.tif',masked=True).squeeze()
total_pollinator_abundance_summer_willamette=rxr.open_rasterio(r'I:\ESVs\pollination\total_pollinator_abundance_summer_willamette.tif',masked=True).squeeze()

f, axes=plt.subplots(1,2,figsize=(13,5))
cmap='gist_ncar'
total_pollinator_abundance_spring_willamette.plot.imshow(ax=axes[0],add_colorbar=False,cmap=cmap)
ax=total_pollinator_abundance_summer_willamette.plot.imshow(ax=axes[1],add_colorbar=False,cmap=cmap)

axes[0].set_title('total_pollinator_abundance_spring_willamette')
axes[1].set_title('total_pollinator_abundance_summer_willamette')

cax,kw = mpl.colorbar.make_axes([ax for ax in axes.flat])
plt.colorbar(ax, cax=cax, **kw)

for ax in axes: ax.tick_params(axis='x', labelrotation=90)
plt.show()
```


<img src="./imgs/3_5_c/output_55_0.png" height='auto' width='auto' title="caDesign">    


#### 2）作物生产

InVEST提供了两个作物生产模型，分别为百分位模型（Percentile Model）和回归模型（Regression Model），分别迁移至`USDA`库，对应`Crop_production_percentile`和`Crop_production_regression`类。分别使用两种方法计算。

* 百分位模型计算


```python
args_crop_production_percentile={
    'workspace_dir':r'I:\ESVs\crop_PP',
    'n_workers':6,
    'results_suffix':'willamette',
    'landcover_raster_path':r'I:\data\invest\CropProduction\sample_user_data\landcover.tif',
    'landcover_to_crop_table_path':r'I:\data\invest\CropProduction\sample_user_data\landcover_to_crop_table.csv',
    'aggregate_polygon_path':r'I:\data\invest\CropProduction\sample_user_data\aggregate_shape.shp',
    'model_data_path':r'I:\data\invest\CropProduction\model_data',
    }

crop_production_percentile=usda_esv.Crop_production_percentile(args_crop_production_percentile)
```

读取打印地图查看小麦的观测和百分位数为75的生产率（production rate），单位为公吨/像素每年。


```python
wheat_observed_production_willamette=rxr.open_rasterio(r'I:\ESVs\crop_PP\wheat_observed_production_willamette.tif',masked=True).squeeze()
wheat_yield_75th_production_willamette=rxr.open_rasterio(r'I:\ESVs\crop_PP\wheat_yield_75th_production_willamette.tif',masked=True).squeeze()

f, axes=plt.subplots(1,2,figsize=(13,5))
cmap='gist_ncar'
wheat_observed_production_willamette.plot.imshow(ax=axes[0],add_colorbar=False,cmap=cmap)
ax=wheat_yield_75th_production_willamette.plot.imshow(ax=axes[1],add_colorbar=False,cmap=cmap)

axes[0].set_title('wheat_observed_production_willamette')
axes[1].set_title('wheat_yield_75th_production_willamette')

cax,kw = mpl.colorbar.make_axes([ax for ax in axes.flat])
plt.colorbar(ax, cax=cax, **kw)

for ax in axes: ax.tick_params(axis='x', labelrotation=90)
plt.show()
```


<img src="./imgs/3_5_c/output_59_0.png" height='auto' width='auto' title="caDesign">    


* 回归模型计算


```python
args_crop_production_regression={
    'workspace_dir':r'I:\ESVs\crop_PR',
    'n_workers':6,
    'results_suffix':'willamette',
    'landcover_raster_path':r'I:\data\invest\CropProduction\sample_user_data\landcover.tif',
    'landcover_to_crop_table_path':r'I:\data\invest\CropProduction\sample_user_data\landcover_to_crop_table.csv',
    'fertilization_rate_table_path':r'I:\data\invest\CropProduction\sample_user_data\crop_fertilization_rates.csv',
    'aggregate_polygon_path':r'I:\data\invest\CropProduction\sample_user_data\aggregate_shape.shp',
    'model_data_path':r'I:\data\invest\CropProduction\model_data',
    }

crop_production_regression=usda_esv.Crop_production_regression(args_crop_production_regression)
```

读取打印地图查看小麦的生产率。


```python
wheat_regression_production_willamette=rxr.open_rasterio(r'I:\ESVs\crop_PR\wheat_regression_production_willamette.tif',masked=True).squeeze()

f, ax=plt.subplots(1,1,figsize=(6,5))
cmap='gist_ncar'
wheat_regression_production_willamette.plot.imshow(ax=ax,add_colorbar=True,cmap=cmap)
ax.set_title('wheat_regression_production_willamette')

ax.tick_params(axis='x', labelrotation=90)
plt.show()
```


<img src="./imgs/3_5_c/output_63_0.png" height='auto' width='auto' title="caDesign">    


## 3.5.4 生态系统服务价值的贝叶斯网络构建与推理

前文通过 InVEST 计算了生态系统服务价值中的碳储存和封存、生境质量、作物授粉和作物生产等4类服务，并获得了相应的计算结果。接下来希望能够分析这4类服务变量之间的相互关系，建立可以推断与权衡的模型。用[pgmpy库](https://github.com/pgmpy/pgmpy)<sup>㉙</sup>的`BayesianNetwork`方法构建离散型贝叶斯网络（Bayesian Network，BN）；根据前文计算的数据，对网络模型随机变量节点进行参数估计获得各个随机变量的条件概率分布（Conditional probability distribution，CPD）；进而应用建立的 BN 模型进行推理，给定某一随机变量的证据（evidence）估计其它随机变量的状态概率，例如如果假设一个栅格单元的碳储量很高，同时假设该栅格单元也具有很高的生境质量，那么该栅格单元为各个 LULC 类型的概率为多少？同时可以进行条件独立性和有效迹等分析。

### 3.5.4.1 数据准备——构建数据集

就生态系统服务价值的计算，并没有选择全部变量，仅选择了7个用以说明贝叶斯网络模型构建、参数估计和推理的方法。7个随机变量分别为当前的 LULC（`lulc_cur`）、未来的 LULC (`lulc_fut`)、碳储存量（`tot_c_cur_willamette`）、碳封存的经济价值（`npv_fut_willamette`）、生境威胁建成区（`Urba`）、当前生境质量（`quality_c_willamette`）、未来生境质量（`quality_f_willamette`）、春季所有物种的总授粉者丰度（`total_pollinator_abundance_spring_willamette`）和小麦的生产率（`wheat_regression_production_willamette`）。


```python
%load_ext autoreload 
%autoreload 2 
import warnings
warnings.filterwarnings('ignore')

import usda.geodata_process as usda_geoprocess
import usda.pgm as usda_pgm

import rioxarray as rxr
from matplotlib_scalebar.scalebar import ScaleBar
import matplotlib.pyplot as plt
import matplotlib
import numpy as np
import pandas as pd
import mapclassify
from pgmpy.models import BayesianNetwork
from pgmpy.estimators import BayesianEstimator, MaximumLikelihoodEstimator
from pgmpy.inference import VariableElimination
```


```python
data_fn_dict={'lulc_cur':r'I:\data\invest\Carbon\lulc_current_willamette.tif',
              'lulc_fut':r'I:\data\invest\Carbon\lulc_future_willamette.tif',
              'tot_c_cur_willamette':r'I:\\ESVs\\carbon\\tot_c_cur_willamette.tif',
              'npv_fut_willamette':r'I:\\ESVs\\carbon\\npv_fut_willamette.tif',
              'Urban':r'I:\data\invest\HabitatQuality\urban_c.tif',
              'quality_c_willamette':r'I:\ESVs\habitat_quality\quality_c_willamette.tif',
              'quality_f_willamette':r'I:\ESVs\habitat_quality\quality_f_willamette.tif',
              'total_pollinator_abundance_spring_willamette':r'I:\ESVs\pollination\total_pollinator_abundance_spring_willamette.tif',
              'wheat_regression_production_willamette':r'I:\ESVs\crop_PR\wheat_regression_production_willamette.tif'}
```

4类生态系统服务价值计算虽然都为威拉米特（willamette）区域，但是分析范围存在差异，因此并未采用栅格波段堆叠的方式合并这7个单独的栅格数据，而是采用了最大重叠区域内采样点提取各个栅格值的方法。首先需要计算所有栅格的最大重叠范围，定义`rasters_minimum_bound()`方法实现，基本逻辑就是获得各个栅格的边界坐标值（`[left, bottom, right, top]`），提取最大或最小值后建立叠合区域的矩形对象。


```python
minimum_bound=usda_geoprocess.rasters_minimum_bound(list(data_fn_dict.values()))    
bound_gdf=minimum_bound['bound_gdf']
bound_gdf
```

    crs:
    {0: CRS.from_epsg(26910), 1: CRS.from_epsg(26910), 2: CRS.from_epsg(26910), 3: CRS.from_epsg(26910), 4: CRS.from_epsg(26910), 5: CRS.from_epsg(26910), 6: CRS.from_epsg(26910), 7: CRS.from_epsg(26910), 8: CRS.from_epsg(26910)}
    




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((468803.127 4928406.906, 468803.127 4...</td>
    </tr>
  </tbody>
</table>
</div>



定义`random_pts_in_geoBounds()`方法获得随机采样点。实验中采样点数据配置为10,000个。


```python
pts_gdf=usda_geoprocess.random_pts_in_geoBounds(bound_gdf,10_000)  
```

叠合打印随意一个 LULC 数据和最大重叠区域及随机采样点，核实计算结果是否正确。重叠区和采样点位于参考 LULC 栅格数据内，表明结果可以使用。


```python
lulc_cur_path=rxr.open_rasterio(data_fn_dict['lulc_cur'],masked=True).squeeze()

f, ax=plt.subplots(1,1,figsize=(20,20))

np.random.seed(10)
cmap=matplotlib.colors.ListedColormap (np.random.rand ( 256,3))
lulc_cur_path.plot.imshow(ax=ax,add_colorbar=False,cmap=cmap)
bound_gdf.plot(color='none',edgecolor='r',linewidth=5,ax=ax,linestyle='--')
pts_gdf.plot(ax=ax,markersize=5,color='k')

ax.add_artist(ScaleBar(1))  
ax.set_axis_off()
plt.tight_layout()
plt.show()
```


<img src="./imgs/3_5_c/output_72_0.png" height='auto' width='auto' title="caDesign">    


定义`extract_raster_vals_at_pts_batch()`方法用采样点采样所有栅格值，并对应 LULC 整数型索引增加实际 LULC 分类名称列`lulc_cur_name`和`lulc_fut_name`。


```python
sample_pt_coords=[(p.x,p.y) for p in pts_gdf.points.values]
sample_vals_array,idx_lst=usda_geoprocess.extract_raster_vals_at_pts_batch(sample_pt_coords,list(data_fn_dict.values()))
```


      0%|          | 0/9 [00:00<?, ?it/s]



    0it [00:00, ?it/s]



```python
carbon_pools_willamette=pd.read_csv(r'I:\data\invest\Carbon\carbon_pools_willamette.csv')
LULC_mapping=dict(carbon_pools_willamette[['lucode','LULC_Name']].values)

sample_vals_df=pd.DataFrame(sample_vals_array,columns=data_fn_dict.keys())
sample_vals_df[['lulc_cur_name','lulc_fut_name']]=sample_vals_df.apply(lambda row:pd.Series([LULC_mapping[int(row.lulc_cur)],LULC_mapping[int(row.lulc_fut)]]),axis=1)
sample_vals_unique_df=sample_vals_df.drop_duplicates()
sample_vals_unique_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lulc_cur</th>
      <th>lulc_fut</th>
      <th>tot_c_cur_willamette</th>
      <th>npv_fut_willamette</th>
      <th>Urban</th>
      <th>quality_c_willamette</th>
      <th>quality_f_willamette</th>
      <th>total_pollinator_abundance_spring_willamette</th>
      <th>wheat_regression_production_willamette</th>
      <th>lulc_cur_name</th>
      <th>lulc_fut_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6.0</td>
      <td>6.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.088110</td>
      <td>-1.0</td>
      <td>Commercial</td>
      <td>Commercial</td>
    </tr>
    <tr>
      <th>1</th>
      <td>53.0</td>
      <td>56.0</td>
      <td>42.750000</td>
      <td>-2685.426514</td>
      <td>0.0</td>
      <td>0.014660</td>
      <td>0.013035</td>
      <td>0.055686</td>
      <td>-1.0</td>
      <td>Forest Closed hardwood</td>
      <td>Conifers 0-20 yrs</td>
    </tr>
    <tr>
      <th>2</th>
      <td>83.0</td>
      <td>1.0</td>
      <td>2.970000</td>
      <td>375.039856</td>
      <td>0.0</td>
      <td>0.032672</td>
      <td>0.032672</td>
      <td>0.084252</td>
      <td>-1.0</td>
      <td>Hayfield</td>
      <td>Residential 0-4 units/acre</td>
    </tr>
    <tr>
      <th>3</th>
      <td>67.0</td>
      <td>67.0</td>
      <td>1.080000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.093392</td>
      <td>0.079692</td>
      <td>0.106351</td>
      <td>-1.0</td>
      <td>Grass seed rotation</td>
      <td>Grass seed rotation</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>7.740000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.015323</td>
      <td>0.015414</td>
      <td>0.117574</td>
      <td>-1.0</td>
      <td>Residential 0-4 units/acre</td>
      <td>Residential 0-4 units/acre</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9995</th>
      <td>84.0</td>
      <td>84.0</td>
      <td>2.070000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.077150</td>
      <td>0.073046</td>
      <td>0.105832</td>
      <td>-1.0</td>
      <td>Late field crop</td>
      <td>Late field crop</td>
    </tr>
    <tr>
      <th>9996</th>
      <td>57.0</td>
      <td>58.0</td>
      <td>24.480000</td>
      <td>1188.805420</td>
      <td>0.0</td>
      <td>0.020732</td>
      <td>0.020690</td>
      <td>0.055342</td>
      <td>-1.0</td>
      <td>Forest closed conifer 21-40 yrs</td>
      <td>Forest closed conifer 41-60 yrs</td>
    </tr>
    <tr>
      <th>9997</th>
      <td>71.0</td>
      <td>1.0</td>
      <td>1.350000</td>
      <td>502.411865</td>
      <td>0.0</td>
      <td>0.038543</td>
      <td>0.037324</td>
      <td>0.101100</td>
      <td>-1.0</td>
      <td>Grains</td>
      <td>Residential 0-4 units/acre</td>
    </tr>
    <tr>
      <th>9998</th>
      <td>58.0</td>
      <td>59.0</td>
      <td>39.599998</td>
      <td>877.451660</td>
      <td>0.0</td>
      <td>0.012720</td>
      <td>0.002704</td>
      <td>0.041639</td>
      <td>-1.0</td>
      <td>Forest closed conifer 41-60 yrs</td>
      <td>Forest closed conifer 61-80 yrs</td>
    </tr>
    <tr>
      <th>9999</th>
      <td>82.0</td>
      <td>1.0</td>
      <td>1.260000</td>
      <td>509.488068</td>
      <td>0.0</td>
      <td>0.038406</td>
      <td>0.033619</td>
      <td>0.086102</td>
      <td>-1.0</td>
      <td>Field crop</td>
      <td>Residential 0-4 units/acre</td>
    </tr>
  </tbody>
</table>
<p>9828 rows × 11 columns</p>
</div>



离散化（Data discretization）连续型数据时，对不同的变量，根据其具体数值分布情况，做了不同的离散化处理，例如碳储存分类等区间分类为5级，碳封存的经济价值分类含按值0的划分，建成区分类为二分类等，具体如下代码所示。


```python
sample_vals_discretization_dict={}
discretization_classifiers={}

# A-tot_c_cur_willamette 当前 LULC 碳储存分类
tot_c_cur_disc=mapclassify.EqualInterval(sample_vals_unique_df['tot_c_cur_willamette'],k=5)
discretization_classifiers['totc']=tot_c_cur_disc
sample_vals_discretization_dict['totc']=tot_c_cur_disc.yb

# B-npv_fut_willamette 碳封存的经济价值分类
npv_fut_disc=mapclassify.UserDefined(sample_vals_unique_df['npv_fut_willamette'],bins=[0,1000])
discretization_classifiers['npvfut']=npv_fut_disc
sample_vals_discretization_dict['npvfut']=npv_fut_disc.yb

# C-Urban 生境威胁-建成区分类
discretization_classifiers['Urban']={'0':0,'1':1}
sample_vals_discretization_dict['Urban']=np.array(sample_vals_unique_df['Urban']).astype(int)

# D-quality_c_willamette 当前 LULC 生境质量分类
quality_c_disc=mapclassify.UserDefined(sample_vals_unique_df['quality_c_willamette'],bins=[0.05,0.1])
discretization_classifiers['qualityc']=quality_c_disc
sample_vals_discretization_dict['qualityc']=quality_c_disc.yb

# E-quality_f_willamette 未来 LULC 生境质量分类
quality_f_disc=mapclassify.UserDefined(sample_vals_unique_df['quality_f_willamette'],bins=[0.05,0.1])
discretization_classifiers['qualityf']=quality_f_disc
sample_vals_discretization_dict['qualityf']=quality_f_disc.yb

# F-total_pollinator_abundance_spring_willamette 春季授粉者总丰度分类
total_pollinator_abundance_spring_disc=mapclassify.EqualInterval(sample_vals_unique_df['total_pollinator_abundance_spring_willamette'],k=3)
discretization_classifiers['totalpollinator']=total_pollinator_abundance_spring_disc
sample_vals_discretization_dict['totalpollinator']=total_pollinator_abundance_spring_disc.yb

# G-wheat_regression_production_willamette 小麦生产率分类
wheat_regression_production_disc=mapclassify.UserDefined(sample_vals_unique_df['wheat_regression_production_willamette'],bins=[0,0.12])
discretization_classifiers['wheatproduction']=wheat_regression_production_disc
sample_vals_discretization_dict['wheatproduction']=wheat_regression_production_disc.yb

sample_vals_discretization_df=pd.DataFrame(data=sample_vals_discretization_dict)
sample_vals_discretization_df[['lulccur','lulcfut']]=sample_vals_df[['lulc_cur_name','lulc_fut_name']]
sample_vals_discretization_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>totc</th>
      <th>npvfut</th>
      <th>Urban</th>
      <th>qualityc</th>
      <th>qualityf</th>
      <th>totalpollinator</th>
      <th>wheatproduction</th>
      <th>lulccur</th>
      <th>lulcfut</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>Commercial</td>
      <td>Commercial</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>Forest Closed hardwood</td>
      <td>Conifers 0-20 yrs</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>Hayfield</td>
      <td>Residential 0-4 units/acre</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>Grass seed rotation</td>
      <td>Grass seed rotation</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>Residential 0-4 units/acre</td>
      <td>Residential 0-4 units/acre</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9823</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>Pasture</td>
      <td>Pasture</td>
    </tr>
    <tr>
      <th>9824</th>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>Grass seed rotation</td>
      <td>Grass seed rotation</td>
    </tr>
    <tr>
      <th>9825</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>Forest closed conifer 81-200 yrs</td>
      <td>Conifers 0-20 yrs</td>
    </tr>
    <tr>
      <th>9826</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>Residential 0-4 units/acre</td>
      <td>Residential 0-4 units/acre</td>
    </tr>
    <tr>
      <th>9827</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>Forest Closed mixed</td>
      <td>Forest Closed mixed</td>
    </tr>
  </tbody>
</table>
<p>9828 rows × 9 columns</p>
</div>



离散化的区间划分结果，用于后续推理时查阅。


```python
discretization_classifiers
```




    {'totc': EqualInterval
     
        Interval      Count
     ----------------------
     [ 0.00, 15.75] |  5976
     (15.75, 31.50] |   404
     (31.50, 47.25] |  2654
     (47.25, 63.00] |   254
     (63.00, 78.75] |   540,
     'npvfut': UserDefined
     
           Interval         Count
     ----------------------------
     [-4419.10,     0.00] |  7937
     (    0.00,  1000.00] |  1342
     ( 1000.00,  3156.00] |   549,
     'Urban': {'0': 0, '1': 1},
     'qualityc': UserDefined
     
       Interval     Count
     --------------------
     [0.00, 0.05] |  7906
     (0.05, 0.10] |  1825
     (0.10, 0.74] |    97,
     'qualityf': UserDefined
     
       Interval     Count
     --------------------
     [0.00, 0.05] |  8106
     (0.05, 0.10] |  1646
     (0.10, 0.73] |    76,
     'totalpollinator': EqualInterval
     
       Interval     Count
     --------------------
     [0.00, 0.05] |  1511
     (0.05, 0.10] |  6842
     (0.10, 0.16] |  1475,
     'wheatproduction': UserDefined
     
        Interval      Count
     ----------------------
     [-1.00,  0.00] |  9746
     ( 0.00,  0.12] |    15
     ( 0.12,  0.16] |    67}



### 3.5.4.2 构建贝叶斯网络并参数估计 

根据4类生态系统服务价值计算的关系建立贝叶斯网络图$G$，确定随机变量节点和表征随机变量之间因果关系的边。 


```python
model_ess=BayesianNetwork([
    ('lulccur','totc'),
    ('lulccur','npvfut'),
    ('lulccur','qualityc'),
    ('lulccur','totalpollinator'),
    ('lulccur','wheatproduction'),
    ('lulccur','Urban'),
    ('lulccur','lulcfut'),
    ('lulcfut','npvfut'),
    ('lulcfut','qualityf'),
    ('Urban','qualityf'),
    ('Urban','qualityc'),
    ('totc','npvfut'),
    ])

model_ess_daft=model_ess.to_daft(node_pos={'lulccur':(6,3),'lulcfut':(3,2),'Urban':(1,2),'totc':(2,2),'npvfut':(3,1),'qualityc':(4,1),'qualityf':(5,1),'totalpollinator':(6,1),'wheatproduction':(8,1)})
model_ess_daft.render(dpi=120);
```


<img src="./imgs/3_5_c/output_81_0.png" height='auto' width='auto' title="caDesign">    


参数估计采用了贝叶斯参数估计的方法。


```python
model_ess.fit(data=sample_vals_discretization_df, 
          estimator=BayesianEstimator,
          prior_type="BDeu",
          equivalent_sample_size=10,
          complete_samples_only=False)
```

打印参数，即各个随机变量的 CPD（或称为随机概率表，conditional probability tables，CPT）。


```python
print(f'Check model: {model_ess.check_model()}\n')
for cpd in model_ess.get_cpds():
    print(f'CPT of {cpd.variable}:')
    print(cpd, '\n')
```

    Check model: True
    
    CPT of lulccur:
    +---------------------------------------------------+-------------+
    | lulccur(Bare/fallow)                              | 0.00581268  |
    +---------------------------------------------------+-------------+
    | lulccur(Berries & Vineyards)                      | 0.00682915  |
    +---------------------------------------------------+-------------+
    | lulccur(Burned grass)                             | 0.00012047  |
    +---------------------------------------------------+-------------+
    | lulccur(Christmas trees)                          | 0.0084555   |
    +---------------------------------------------------+-------------+
    | lulccur(Commercial)                               | 0.0101835   |
    +---------------------------------------------------+-------------+
    | lulccur(Commercial/Industrial)                    | 0.0023567   |
    +---------------------------------------------------+-------------+
    | lulccur(Conifer Woodlot)                          | 0.000628704 |
    +---------------------------------------------------+-------------+
    | lulccur(Conifers 0-20 yrs)                        | 0.0109967   |
    +---------------------------------------------------+-------------+
    | lulccur(Double cropping)                          | 0.000831997 |
    +---------------------------------------------------+-------------+
    | lulccur(Field crop)                               | 0.0290898   |
    +---------------------------------------------------+-------------+
    | lulccur(Flooded/marsh)                            | 0.00530445  |
    +---------------------------------------------------+-------------+
    | lulccur(Forest Closed hardwood)                   | 0.0759489   |
    +---------------------------------------------------+-------------+
    | lulccur(Forest Closed mixed)                      | 0.146492    |
    +---------------------------------------------------+-------------+
    | lulccur(Forest closed conifer 21-40 yrs)          | 0.0131312   |
    +---------------------------------------------------+-------------+
    | lulccur(Forest closed conifer 41-60 yrs)          | 0.0444384   |
    +---------------------------------------------------+-------------+
    | lulccur(Forest closed conifer 61-80 yrs)          | 0.0256338   |
    +---------------------------------------------------+-------------+
    | lulccur(Forest closed conifer 81-200 yrs)         | 0.046573    |
    +---------------------------------------------------+-------------+
    | lulccur(Forest closed conifer older than 200 yrs) | 0.00754068  |
    +---------------------------------------------------+-------------+
    | lulccur(Grains)                                   | 0.0326474   |
    +---------------------------------------------------+-------------+
    | lulccur(Grass)                                    | 0.0157741   |
    +---------------------------------------------------+-------------+
    | lulccur(Grass seed rotation)                      | 0.0661908   |
    +---------------------------------------------------+-------------+
    | lulccur(Hayfield)                                 | 0.0350869   |
    +---------------------------------------------------+-------------+
    | lulccur(Hybrid poplar)                            | 0.00134023  |
    +---------------------------------------------------+-------------+
    | lulccur(Industrial)                               | 0.0067275   |
    +---------------------------------------------------+-------------+
    | lulccur(Irrigated annual crop rotation)           | 0.0177053   |
    +---------------------------------------------------+-------------+
    | lulccur(Irrigated perennial)                      | 0.0109967   |
    +---------------------------------------------------+-------------+
    | lulccur(Late field crop)                          | 0.00255999  |
    +---------------------------------------------------+-------------+
    | lulccur(Light duty roads)                         | 0.0324441   |
    +---------------------------------------------------+-------------+
    | lulccur(Main channel non-vegetated)               | 0.00144188  |
    +---------------------------------------------------+-------------+
    | lulccur(Mint)                                     | 0.00042541  |
    +---------------------------------------------------+-------------+
    | lulccur(Natural grassland)                        | 0.0153675   |
    +---------------------------------------------------+-------------+
    | lulccur(Natural shrub)                            | 0.0686303   |
    +---------------------------------------------------+-------------+
    | lulccur(Orchard)                                  | 0.00937032  |
    +---------------------------------------------------+-------------+
    | lulccur(Pasture)                                  | 0.0595838   |
    +---------------------------------------------------+-------------+
    | lulccur(Permanent lentic water)                   | 0.00815056  |
    +---------------------------------------------------+-------------+
    | lulccur(Railroad)                                 | 0.00418634  |
    +---------------------------------------------------+-------------+
    | lulccur(Residential 0-4 units/acre)               | 0.0751357   |
    +---------------------------------------------------+-------------+
    | lulccur(Residential 4-9 units/acre)               | 0.00530445  |
    +---------------------------------------------------+-------------+
    | lulccur(Residential 9-16 units/acre)              | 0.00296658  |
    +---------------------------------------------------+-------------+
    | lulccur(Residential >16 units/acre)               | 0.00042541  |
    +---------------------------------------------------+-------------+
    | lulccur(Row crop)                                 | 0.00591433  |
    +---------------------------------------------------+-------------+
    | lulccur(Rural non-vegetated unknown)              | 0.0100818   |
    +---------------------------------------------------+-------------+
    | lulccur(Rural structures)                         | 0.00611762  |
    +---------------------------------------------------+-------------+
    | lulccur(Secondary roads)                          | 0.00855714  |
    +---------------------------------------------------+-------------+
    | lulccur(Stream orders 5-7)                        | 0.00601598  |
    +---------------------------------------------------+-------------+
    | lulccur(Sugar beet seed)                          | 0.000222117 |
    +---------------------------------------------------+-------------+
    | lulccur(Topographic Shadow)                       | 0.000222117 |
    +---------------------------------------------------+-------------+
    | lulccur(Turfgrass)                                | 0.00713409  |
    +---------------------------------------------------+-------------+
    | lulccur(Upland Forest Semi-closed conifer)        | 0.000527057 |
    +---------------------------------------------------+-------------+
    | lulccur(Upland Forest Semi-closed hardwood)       | 0.00184846  |
    +---------------------------------------------------+-------------+
    | lulccur(Upland Forest Semi-closed mixed)          | 0.00195011  |
    +---------------------------------------------------+-------------+
    | lulccur(Upland Forest open)                       | 0.00042541  |
    +---------------------------------------------------+-------------+
    | lulccur(Urban non-vegetated unknown)              | 0.0263453   |
    +---------------------------------------------------+-------------+
    | lulccur(Urban tree overstory)                     | 0.0118098   |
    +---------------------------------------------------+-------------+ 
    
    CPT of totc:
    +---------+----------------------+-----+-------------------------------+
    | lulccur | lulccur(Bare/fallow) | ... | lulccur(Urban tree overstory) |
    +---------+----------------------+-----+-------------------------------+
    | totc(0) | 0.577720207253886    | ... | 0.5597704813516098            |
    +---------+----------------------+-----+-------------------------------+
    | totc(1) | 0.03562176165803109  | ... | 0.08638826904686005           |
    +---------+----------------------+-----+-------------------------------+
    | totc(2) | 0.280440414507772    | ... | 0.27574115396876              |
    +---------+----------------------+-----+-------------------------------+
    | totc(3) | 0.03562176165803109  | ... | 0.008925725215173732          |
    +---------+----------------------+-----+-------------------------------+
    | totc(4) | 0.0705958549222798   | ... | 0.06917437041759641           |
    +---------+----------------------+-----+-------------------------------+ 
    
    CPT of npvfut:
    +-----------+------------------------+-----+-------------------------------+
    | lulccur   | lulccur(Bare/fallow)   | ... | lulccur(Urban tree overstory) |
    +-----------+------------------------+-----+-------------------------------+
    | lulcfut   | lulcfut(Bare/fallow)   | ... | lulcfut(Urban tree overstory) |
    +-----------+------------------------+-----+-------------------------------+
    | totc      | totc(0)                | ... | totc(4)                       |
    +-----------+------------------------+-----+-------------------------------+
    | npvfut(0) | 0.8420850240008487     | ... | 0.9999370177924738            |
    +-----------+------------------------+-----+-------------------------------+
    | npvfut(1) | 0.15790171586177634    | ... | 3.1491103763186906e-05        |
    +-----------+------------------------+-----+-------------------------------+
    | npvfut(2) | 1.3260137375023207e-05 | ... | 3.1491103763186906e-05        |
    +-----------+------------------------+-----+-------------------------------+ 
    
    CPT of qualityc:
    +-------------+----------------------+-----+-------------------------------+
    | Urban       | Urban(0)             | ... | Urban(1)                      |
    +-------------+----------------------+-----+-------------------------------+
    | lulccur     | lulccur(Bare/fallow) | ... | lulccur(Urban tree overstory) |
    +-------------+----------------------+-----+-------------------------------+
    | qualityc(0) | 0.7585301837270341   | ... | 0.9932111337406654            |
    +-------------+----------------------+-----+-------------------------------+
    | qualityc(1) | 0.2224124158393244   | ... | 0.0033944331296673455         |
    +-------------+----------------------+-----+-------------------------------+
    | qualityc(2) | 0.01905740043364144  | ... | 0.0033944331296673455         |
    +-------------+----------------------+-----+-------------------------------+ 
    
    CPT of totalpollinator:
    +--------------------+----------------------+-----+-------------------------------+
    | lulccur            | lulccur(Bare/fallow) | ... | lulccur(Urban tree overstory) |
    +--------------------+----------------------+-----+-------------------------------+
    | totalpollinator(0) | 0.12348877374784112  | ... | 0.15545638083094251           |
    +--------------------+----------------------+-----+-------------------------------+
    | totalpollinator(1) | 0.718048359240069    | ... | 0.689087238338115             |
    +--------------------+----------------------+-----+-------------------------------+
    | totalpollinator(2) | 0.1584628670120898   | ... | 0.15545638083094251           |
    +--------------------+----------------------+-----+-------------------------------+ 
    
    CPT of wheatproduction:
    +--------------------+----------------------+-----+-------------------------------+
    | lulccur            | lulccur(Bare/fallow) | ... | lulccur(Urban tree overstory) |
    +--------------------+----------------------+-----+-------------------------------+
    | wheatproduction(0) | 0.9978411053540588   | ... | 0.9903304643502283            |
    +--------------------+----------------------+-----+-------------------------------+
    | wheatproduction(1) | 0.001079447322970639 | ... | 0.000531293167569865          |
    +--------------------+----------------------+-----+-------------------------------+
    | wheatproduction(2) | 0.001079447322970639 | ... | 0.009138242482201677          |
    +--------------------+----------------------+-----+-------------------------------+ 
    
    CPT of Urban:
    +----------+----------------------+-----+-------------------------------+
    | lulccur  | lulccur(Bare/fallow) | ... | lulccur(Urban tree overstory) |
    +----------+----------------------+-----+-------------------------------+
    | Urban(0) | 0.9459196891191709   | ... | 0.9217405164169589            |
    +----------+----------------------+-----+-------------------------------+
    | Urban(1) | 0.05408031088082901  | ... | 0.07825948358304112           |
    +----------+----------------------+-----+-------------------------------+ 
    
    CPT of lulcfut:
    +---------------------------------------------------+-----+-------------------------------+
    | lulccur                                           | ... | lulccur(Urban tree overstory) |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Bare/fallow)                              | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Berries & Vineyards)                      | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Christmas trees)                          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Commercial)                               | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Commercial/Industrial)                    | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Conifer Woodlot)                          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Conifers 0-20 yrs)                        | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Double cropping)                          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Field crop)                               | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Flooded/marsh)                            | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Forest Closed hardwood)                   | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Forest Closed mixed)                      | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Forest closed conifer 21-40 yrs)          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Forest closed conifer 41-60 yrs)          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Forest closed conifer 61-80 yrs)          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Forest closed conifer 81-200 yrs)         | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Forest closed conifer older than 200 yrs) | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Grains)                                   | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Grass)                                    | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Grass seed rotation)                      | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Hayfield)                                 | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Industrial)                               | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Irrigated annual crop rotation)           | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Irrigated perennial)                      | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Late field crop)                          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Light duty roads)                         | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Main channel non-vegetated)               | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Mint)                                     | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Natural grassland)                        | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Natural shrub)                            | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Orchard)                                  | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Pasture)                                  | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Permanent lentic water)                   | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Railroad)                                 | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Residential 0-4 units/acre)               | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Residential 4-9 units/acre)               | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Residential 9-16 units/acre)              | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Residential >16 units/acre)               | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Row crop)                                 | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Rural non-vegetated unknown)              | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Rural structures)                         | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Secondary roads)                          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Stream orders 5-7)                        | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Sugar beet seed)                          | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Topographic Shadow)                       | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Turfgrass)                                | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Upland Forest Semi-closed conifer)        | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Urban non-vegetated unknown)              | ... | 3.252815311652235e-05         |
    +---------------------------------------------------+-----+-------------------------------+
    | lulcfut(Urban tree overstory)                     | ... | 0.9984386486504069            |
    +---------------------------------------------------+-----+-------------------------------+ 
    
    CPT of qualityf:
    +-------------+-----------------------+-----+-------------------------------+
    | Urban       | Urban(0)              | ... | Urban(1)                      |
    +-------------+-----------------------+-----+-------------------------------+
    | lulcfut     | lulcfut(Bare/fallow)  | ... | lulcfut(Urban tree overstory) |
    +-------------+-----------------------+-----+-------------------------------+
    | qualityf(0) | 0.6652554332486593    | ... | 0.9925261584454411            |
    +-------------+-----------------------+-----+-------------------------------+
    | qualityf(1) | 0.3333333333333333    | ... | 0.0037369207772795228         |
    +-------------+-----------------------+-----+-------------------------------+
    | qualityf(2) | 0.0014112334180073386 | ... | 0.0037369207772795228         |
    +-------------+-----------------------+-----+-------------------------------+ 
    
    

### 3.5.4.3 网络分析和推理

* 独立性分析

对于该 BN 模型，所有可能给出的证据（evidence），可以做出1110个有效的独立性断言（valid independence assertions）。使用`local_independencies`方法返回随机变量的局部独立性实例，为网络中任何节点独立于给定其父节点的非后代节点。例如，给定证据`lulccur`，随机变量`lulcfut, wheatproduction, totc, npvfut, totalpollinator `独立于随机变量`Urban`。


```python
print(f'There can be made {len(model_ess.get_independencies().get_assertions())}',
      'valid independence assertions with respect to the all possible given evidence.')
print('For instance, any node in the network is independent of its non-descendents given its parents (local semantics):\n',
      f'\n{model_ess.local_independencies(list(model_ess.nodes()))}\n')
```

    There can be made 1110 valid independence assertions with respect to the all possible given evidence.
    For instance, any node in the network is independent of its non-descendents given its parents (local semantics):
     
    (totc ⟂ Urban, lulcfut, wheatproduction, qualityf, qualityc, totalpollinator | lulccur)
    (npvfut ⟂ Urban, wheatproduction, qualityf, qualityc, totalpollinator | lulcfut, lulccur, totc)
    (qualityc ⟂ lulcfut, wheatproduction, totc, qualityf, npvfut, totalpollinator | Urban, lulccur)
    (totalpollinator ⟂ Urban, lulcfut, wheatproduction, totc, qualityf, qualityc, npvfut | lulccur)
    (wheatproduction ⟂ Urban, lulcfut, totc, qualityf, npvfut, qualityc, totalpollinator | lulccur)
    (Urban ⟂ lulcfut, wheatproduction, totc, npvfut, totalpollinator | lulccur)
    (lulcfut ⟂ Urban, wheatproduction, totc, qualityc, totalpollinator | lulccur)
    (qualityf ⟂ wheatproduction, totc, npvfut, lulccur, qualityc, totalpollinator | Urban, lulcfut)
    
    

* 独立性断言（independence assertions）

判断给定的一个随机变量与另一个随机变量之间的独立性，可以给或不给定证据。例如，没有观测到任何证据时，随机变量`totalpollinator`和`wheatproduction`之间并不相互独立（`False`）；但给定证据`lulccur`时，两个随机变量之间相互独立（True）。


```python
usda_pgm.check_assertion(model_ess, independent=['qualityc'], from_variables=['lulccur'], evidence=['lulcfur'])
usda_pgm.check_assertion(model_ess, independent=['npvfut'], from_variables=['wheatproduction'], evidence=['lulccur'])

usda_pgm.check_assertion(model_ess, independent=['totalpollinator'], from_variables=['wheatproduction'], evidence=[])
usda_pgm.check_assertion(model_ess, independent=['totalpollinator'], from_variables=['wheatproduction'], evidence=['lulccur'])
```

    (qualityc ⟂ lulccur | lulcfur): False
    (npvfut ⟂ wheatproduction | lulccur): True
    (totalpollinator ⟂ wheatproduction): False
    (totalpollinator ⟂ wheatproduction | lulccur): True
    

* 有效迹分析

检查一个随机变量是否对另一个随机变量有影响时，可以通过有效迹计算查看。例如，当没有观测到的证据时，`wheatproduction`与其它的所有变量之间均存在有效迹；但是，当观测到证据`lulccur`时，该变量和其它变量之间则无有效迹。


```python
usda_pgm.active_trails_of(model_ess,query='wheatproduction', evidence=[])
usda_pgm.active_trails_of(model_ess,query='wheatproduction', evidence=['lulccur'])
```

    Active trails between 'wheatproduction' and {'totc', 'qualityf', 'qualityc', 'totalpollinator', 'Urban', 'lulcfut', 'lulccur', 'npvfut'} given no evidence.
    No active trails for 'wheatproduction' given the evidence {'lulccur'}.
    

* 推理

首先试验因果推理（预测），例如观测到证据 LULC 类型（`lulccur`）为商业用地（`Commercial`）时，碳封存的经济价值（`npvfut`）的状态更可能为状态 0，即值`[4419.10, 0.00]`区间，其状态概率为0.8373；当LULC类型为草地（`Grass`）时，可以发现状态为0的概率有所下降，而为状态 1 （区间`(0.00,  1000.00]`）的概率从0.097上升至0.2024，表明碳封存的经济价值可能有所增加。下述计算结果的其它推理分析同。


```python
infer=VariableElimination(model_ess)
usda_pgm.query_report(infer, variables=['totc',], evidence={'lulccur':'Forest closed conifer 21-40 yrs',})
usda_pgm.query_report(infer, variables=['npvfut'], evidence={'lulccur':'Commercial'})
usda_pgm.query_report(infer, variables=['npvfut'], evidence={'lulccur':'Grass'})
usda_pgm.query_report(infer, variables=['qualityc'], evidence={'Urban':0})
usda_pgm.query_report(infer, variables=['qualityc'], evidence={'Urban':1})
usda_pgm.query_report(infer, variables=['qualityc'], evidence={'totc':4})
```

    +---------+-------------+
    | totc    |   phi(totc) |
    +=========+=============+
    | totc(0) |      0.5233 |
    +---------+-------------+
    | totc(1) |      0.1112 |
    +---------+-------------+
    | totc(2) |      0.2777 |
    +---------+-------------+
    | totc(3) |      0.0320 |
    +---------+-------------+
    | totc(4) |      0.0558 |
    +---------+-------------+
    --- Query executed in 0.0020 seconds ---
    
    +-----------+---------------+
    | npvfut    |   phi(npvfut) |
    +===========+===============+
    | npvfut(0) |        0.8373 |
    +-----------+---------------+
    | npvfut(1) |        0.0971 |
    +-----------+---------------+
    | npvfut(2) |        0.0655 |
    +-----------+---------------+
    --- Query executed in 0.0070 seconds ---
    
    +-----------+---------------+
    | npvfut    |   phi(npvfut) |
    +===========+===============+
    | npvfut(0) |        0.7411 |
    +-----------+---------------+
    | npvfut(1) |        0.2024 |
    +-----------+---------------+
    | npvfut(2) |        0.0566 |
    +-----------+---------------+
    --- Query executed in 0.0060 seconds ---
    
    +-------------+-----------------+
    | qualityc    |   phi(qualityc) |
    +=============+=================+
    | qualityc(0) |          0.7902 |
    +-------------+-----------------+
    | qualityc(1) |          0.1997 |
    +-------------+-----------------+
    | qualityc(2) |          0.0101 |
    +-------------+-----------------+
    --- Query executed in 0.0020 seconds ---
    
    +-------------+-----------------+
    | qualityc    |   phi(qualityc) |
    +=============+=================+
    | qualityc(0) |          0.9938 |
    +-------------+-----------------+
    | qualityc(1) |          0.0031 |
    +-------------+-----------------+
    | qualityc(2) |          0.0031 |
    +-------------+-----------------+
    --- Query executed in 0.0020 seconds ---
    
    +-------------+-----------------+
    | qualityc    |   phi(qualityc) |
    +=============+=================+
    | qualityc(0) |          0.8014 |
    +-------------+-----------------+
    | qualityc(1) |          0.1888 |
    +-------------+-----------------+
    | qualityc(2) |          0.0098 |
    +-------------+-----------------+
    --- Query executed in 0.0020 seconds ---
    
    

试验证据推理（解释），例如如果希望碳储量（`totc`）、生境质量（`qualityc`）和授粉者丰度（`totalpollinator`）的值都趋向于高值，即为状态 2 时，那么推断 LULC 各分类的概率可以得知，土地覆盖类型更可能为郁闭混交林（`Forest Closed mixed`），其状态概率为0.2031；而最不可能的土地覆盖类型有被烧过的草地（`Burned grass`）、针叶林（`Conifer Woodlot`）、杂交杨树（`Hybrid poplar`）等，其状态概率均为0。


```python
usda_pgm.query_report(infer, variables=['lulccur'], evidence={'totc':2,'qualityc':2,'totalpollinator':2,},)
```

    +---------------------------------------------------+----------------+
    | lulccur                                           |   phi(lulccur) |
    +===================================================+================+
    | lulccur(Bare/fallow)                              |         0.0129 |
    +---------------------------------------------------+----------------+
    | lulccur(Berries & Vineyards)                      |         0.0008 |
    +---------------------------------------------------+----------------+
    | lulccur(Burned grass)                             |         0.0000 |
    +---------------------------------------------------+----------------+
    | lulccur(Christmas trees)                          |         0.0072 |
    +---------------------------------------------------+----------------+
    | lulccur(Commercial)                               |         0.0003 |
    +---------------------------------------------------+----------------+
    | lulccur(Commercial/Industrial)                    |         0.0003 |
    +---------------------------------------------------+----------------+
    | lulccur(Conifer Woodlot)                          |         0.0000 |
    +---------------------------------------------------+----------------+
    | lulccur(Conifers 0-20 yrs)                        |         0.0005 |
    +---------------------------------------------------+----------------+
    | lulccur(Double cropping)                          |         0.0006 |
    +---------------------------------------------------+----------------+
    | lulccur(Field crop)                               |         0.0473 |
    +---------------------------------------------------+----------------+
    | lulccur(Flooded/marsh)                            |         0.0006 |
    +---------------------------------------------------+----------------+
    | lulccur(Forest Closed hardwood)                   |         0.0746 |
    +---------------------------------------------------+----------------+
    | lulccur(Forest Closed mixed)                      |         0.2031 |
    +---------------------------------------------------+----------------+
    | lulccur(Forest closed conifer 21-40 yrs)          |         0.0004 |
    +---------------------------------------------------+----------------+
    | lulccur(Forest closed conifer 41-60 yrs)          |         0.0530 |
    +---------------------------------------------------+----------------+
    | lulccur(Forest closed conifer 61-80 yrs)          |         0.0151 |
    +---------------------------------------------------+----------------+
    | lulccur(Forest closed conifer 81-200 yrs)         |         0.0124 |
    +---------------------------------------------------+----------------+
    | lulccur(Forest closed conifer older than 200 yrs) |         0.0123 |
    +---------------------------------------------------+----------------+
    | lulccur(Grains)                                   |         0.0368 |
    +---------------------------------------------------+----------------+
    | lulccur(Grass)                                    |         0.0007 |
    +---------------------------------------------------+----------------+
    | lulccur(Grass seed rotation)                      |         0.0522 |
    +---------------------------------------------------+----------------+
    | lulccur(Hayfield)                                 |         0.0371 |
    +---------------------------------------------------+----------------+
    | lulccur(Hybrid poplar)                            |         0.0000 |
    +---------------------------------------------------+----------------+
    | lulccur(Industrial)                               |         0.0127 |
    +---------------------------------------------------+----------------+
    | lulccur(Irrigated annual crop rotation)           |         0.0296 |
    +---------------------------------------------------+----------------+
    | lulccur(Irrigated perennial)                      |         0.0007 |
    +---------------------------------------------------+----------------+
    | lulccur(Late field crop)                          |         0.0005 |
    +---------------------------------------------------+----------------+
    | lulccur(Light duty roads)                         |         0.0430 |
    +---------------------------------------------------+----------------+
    | lulccur(Main channel non-vegetated)               |         0.0011 |
    +---------------------------------------------------+----------------+
    | lulccur(Mint)                                     |         0.0002 |
    +---------------------------------------------------+----------------+
    | lulccur(Natural grassland)                        |         0.0007 |
    +---------------------------------------------------+----------------+
    | lulccur(Natural shrub)                            |         0.0832 |
    +---------------------------------------------------+----------------+
    | lulccur(Orchard)                                  |         0.0157 |
    +---------------------------------------------------+----------------+
    | lulccur(Pasture)                                  |         0.0738 |
    +---------------------------------------------------+----------------+
    | lulccur(Permanent lentic water)                   |         0.0006 |
    +---------------------------------------------------+----------------+
    | lulccur(Railroad)                                 |         0.0102 |
    +---------------------------------------------------+----------------+
    | lulccur(Residential 0-4 units/acre)               |         0.0712 |
    +---------------------------------------------------+----------------+
    | lulccur(Residential 4-9 units/acre)               |         0.0007 |
    +---------------------------------------------------+----------------+
    | lulccur(Residential 9-16 units/acre)              |         0.0057 |
    +---------------------------------------------------+----------------+
    | lulccur(Residential >16 units/acre)               |         0.0002 |
    +---------------------------------------------------+----------------+
    | lulccur(Row crop)                                 |         0.0007 |
    +---------------------------------------------------+----------------+
    | lulccur(Rural non-vegetated unknown)              |         0.0007 |
    +---------------------------------------------------+----------------+
    | lulccur(Rural structures)                         |         0.0101 |
    +---------------------------------------------------+----------------+
    | lulccur(Secondary roads)                          |         0.0008 |
    +---------------------------------------------------+----------------+
    | lulccur(Stream orders 5-7)                        |         0.0102 |
    +---------------------------------------------------+----------------+
    | lulccur(Sugar beet seed)                          |         0.0002 |
    +---------------------------------------------------+----------------+
    | lulccur(Topographic Shadow)                       |         0.0006 |
    +---------------------------------------------------+----------------+
    | lulccur(Turfgrass)                                |         0.0058 |
    +---------------------------------------------------+----------------+
    | lulccur(Upland Forest Semi-closed conifer)        |         0.0010 |
    +---------------------------------------------------+----------------+
    | lulccur(Upland Forest Semi-closed hardwood)       |         0.0006 |
    +---------------------------------------------------+----------------+
    | lulccur(Upland Forest Semi-closed mixed)          |         0.0114 |
    +---------------------------------------------------+----------------+
    | lulccur(Upland Forest open)                       |         0.0007 |
    +---------------------------------------------------+----------------+
    | lulccur(Urban non-vegetated unknown)              |         0.0265 |
    +---------------------------------------------------+----------------+
    | lulccur(Urban tree overstory)                     |         0.0128 |
    +---------------------------------------------------+----------------+
    --- Query executed in 0.0060 seconds ---
    
    

---

注释（Notes）：

① 2005年千年生态系统评估（Millennium Ecosystem Assessment，MA）报告，（<https://www.millenniumassessment.org/en/Index-2.html>）。

② Luke Brander，（<http://lukebrander.com/>）。

③ 可持续发展基金会（Foundation for Sustainable Development，FSD），（<https://fsd.nl/who-we-are/>）。

④ 英国苏格兰农业学院（Scotlands Rural College，SRUC），（<https://www.sruc.ac.uk/>）。

⑤ ESVD（Ecosystem Services Valuation Database，（<https://www.esvd.net/>）。

⑥ InVEST（Integrated Valuation of Ecosystem Services and Tradeoffs），（<https://naturalcapitalproject.stanford.edu/software/invest>）。

⑦ InVEST 应用程序编程接口（application programming interface，API ），（<https://invest.readthedocs.io/en/latest/>）。

⑧ NatCap（natural capital） 研究团队，（<https://naturalcapitalproject.stanford.edu/about/people>）。

⑨ PyGeoprocessing，（<https://pygeoprocessing.readthedocs.io/en/latest/>）。

⑩ VITO，（<https://vito.be/en>）。

⑪ Nature Value Explorer（NVE）（Natuur waarde verkenner（荷兰语），NWV），（<https://www.natuurwaardeverkenner.be/#contact>）。

⑫ 全球大气研究排放数据库（Emissions Database for Global Atmospheric Research，EDGAR，（<https://edgar.jrc.ec.europa.eu/>）。

⑬ 政府间气候变化专门委员会（Intergovernmental Panel on Climate Change，IPCC），（<https://www.ipcc.ch/>）。

⑭ EDGAR，（<https://edgar.jrc.ec.europa.eu/report_2022>）。

⑮ Dash（plotly），（<https://dash.plotly.com/installation>）。

⑯ USDA_dashboard，（<https://github.com/richieBao/USDA_dashboard>）。

⑰ 联合国环境规划署（United Nations Environment Programme）对世界各国温室气体（$CO_2$）数据的可视化描述，（<https://www.unep.org/explore-topics/climate-action/what-we-do/climate-action-note/state-of-climate.html>）。

⑱ NWV土壤中的碳封存，（<https://natuurwaardeverkenner.be/docs/manual_EN/regulerende_diensten/omgeving/carbonsoil>）。

⑲ NWV生物质能（biomass）中的碳封存，（<https://natuurwaardeverkenner.be/docs/manual_EN/regulerende_diensten/omgeving/carbonbiomass>）。

⑳ NWV 生态系统服务在线计算，（<https://www.natuurwaardeverkenner.be/>）。

㉑ InVEST 碳储存和封存，（<https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/carbonstorage.html)>）。
 
㉒ InVEST 海岸带蓝碳（Coastal Blue Carbon）， （<https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/coastal_blue_carbon.html>）。

㉓ InVEST 森林碳边缘效应（Forest Carbon Edge Effect），（<https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/carbon_edge.html>）。

㉔ InVEST 案例数据，（<http://releases.naturalcapitalproject.org/?prefix=invest/3.13.0/data/>）。

㉕ 杨元合课题组发布青藏高原高寒草地土壤碳库及其动态变化专题数据，（<http://www.nesdc.org.cn/collection/view/6124789b7e28172cbed3d803>）。

㉖ 国家温室气体清单指南（农业、森林和其它土地利用），（<https://www.ipcc-nggip.iges.or.jp/public/2006gl/vol4.html>）。

㉗ InVEST 其它一些碳库碳储存估算的数据来源，（<https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/data_sources.html#belowground-biomass>）。

㉘ pygeoprocessin库distance_transform_edt距离计算方法，（<https://pygeoprocessing.readthedocs.io/en/latest/api/pygeoprocessing.html#pygeoprocessing.distance_transform_edt>）。

㉙ pgmpy库，（<https://github.com/pgmpy/pgmpy>）。

参考文献（References）:

[1] Chapin, F. Stuart, Pamela A. Matson, and Peter M. Vitousek. 2011. Principles of Terrestrial Ecosystem Ecology. 2nd ed. New York, NY: Springer.

[2] Ecosystem-Wikipedia, <https://en.wikipedia.org/wiki/Ecosystem>.

[3] Ecosystem service-Wikipedia, <https://en.wikipedia.org/wiki/Ecosystem_service>.

[4] What is biodiversity? Why it's under threat and why it matters,<https://www.worldwildlife.org/pages/what-is-biodiversity>.

[5] Barbier, E. B. et al. The value of estuarine and coastal ecosystem services. Ecological Monographs vol. 81 (2011).

[6] 刘纪远，岳天祥，鞠洪波等主编.中国西部生态系统综合评估概要（千年生态系统评估国际合作项目）.2005.

[7] Ecosystem valuation-Wikipedia,<https://en.wikipedia.org/wiki/Ecosystem_valuation>.

[8] Seminar, J. B. & Boyd, J. Speaker Economic Valuation, Ecosystem Services, and Conservation Strategy.

[9] Brander, L.M. de Groot, R, Guisado Goñi, V., van 't Hoff, V., Schägner, P., Solomonides, S., McVittie, A., Eppink, F., Sposato, M., Do, L., Ghermandi, A., and Sinclair, M. (2023). Ecosystem Services Valuation Database (ESVD). Foundation for Sustainable Development and Brander Environmental Economics.

[10] 石铁矛,李沛颖,汤煜.碳中和背景下城市碳汇功能及提升策略——以沈阳核心区为例[J].中国园林,2022,38(03):78-83.DOI:10.19775/j.cla.2022.03.0078.

[11] Crippa, M., Guizzardi, D., Banja, M., Solazzo, E., Muntean, M., Schaaf, E., Pagani, F., Monforti-Ferrario, F., Olivier, J., Quadrelli, R., Risquez Martin, A., Taghavi-Moharamli, P., Grassi, G., Rossi, S., Jacome Felix Oom, D., Branco, A., San-Miguel-Ayanz, J. and Vignati, E., CO2 emissions of all world countries - JRC/IEA/PBL 2022 Report, EUR 31182 EN, Publications Office of the European Union, Luxembourg, 2022, doi:10.2760/730164, JRC130363.

[12] IEA-EDGAR CO2, a component of the EDGAR (Emissions Database for Global Atmospheric Research) Community GHG database version 7.0 (2022) including or based on data from IEA (2021) Greenhouse Gas Emissions from Energy, www.iea.org/data-and-statistics, as modified by the Joint Research Centre.

[13] 张桂莲,仲启铖,张浪.面向碳中和的城市园林绿化碳汇能力建设研究[J].风景园林,2022,29(05):12-16.DOI:10.14085/j.fjyl.2022.05.0012.05.

[14] 武静,蒋卓利,吴晓露.城市蓝绿空间的碳汇研究热点与趋势分析[J].风景园林,2022,29(12):43-49.DOI:10.14085/j.fjyl.2022.12.0043.07.

[15] 王振坤,董心悦,邵明,姚朋.国内外城乡绿色空间碳汇研究进展与展望[J].风景园林,2023,30(02):115-122.DOI:10.14085/j.fjyl.202207310459.

[16] Huang, L., Chen, K. & Zhou, M. Climate change and carbon sink: a bibliometric analysis. Environmental Science and Pollution Research 27, 8740–8758 (2020).

[17] Meersmans, J., F. De Ridder, et al. 2008. "A multiple regression approach to assess the spatial distribution of Soil Organic Carbon (SOC) at the regional scale (Flanders, Belgium)." Geoderma 143(1-2): 1-13.

[18] Vos, P., Janssen, S., Verhees, L., de Wolff, J., Erbrink, H., 2012. Modellering van het effect van wegbegeleidend luchtgroen op de luchtkwaliteit. VITO Rapport nr 2012/RMA/R/112, VITO.

[19] Altor, A. E. and W. J. Mitsch, 2008. "Methane and carbon dioxide dynamics in wetland mesocosms: Effects of hydrology and soils." Ecological Applications 18(5): 1307-1320

[20] Kuik O, Brander L, Tol RSJ. Marginal abatement costs of greenhouse gas emissions: A meta-analysis. Energy Policy 2009; 37:1395–1403.

[21] De Nocker, L; Michiels, H; Deutsch, F; Lefebvre, W; Buekers, J; Torfs R. 2010. Actualisering van de externe milieuschadekosten (algemeen voor Vlaanderen) met betrekking tot luchtverontreiniging en klimaatverandering; Studie uitgevoerd in opdracht van MIRA, Milieurapport Vlaanderen MIRA/2010/03; December 2010; 122 p. , https://www.milieurapport.be/

[22] Van de Walle et al. 2005 Growing stock-based assessment of the carbon stock in the Belgian forest biomass. Annals of Forest Science 62: 1-12

[23] Carbon Storage and Sequestration, <https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/carbonstorage.html>.

[24] Stern, N. 2007. The Economics of Climate Change: The Stern Review. Cambridge and New York: Cambridge University Press.

[25] Tol, RSJ. 2009. The Economic Effects of Climate Change.Journal of Economic Perspectives 23:29-51.

[26] Nordhaus, W. 2007a. Critical Assumptions in the Stern Review on Climate Change. Science 317 (5835): 201--202.

[27] 卿苗,赵军,冯超,黄治化,温媛媛,张伟婕.1980—2030年石羊河流域生态系统碳储存服务对土地利用变化的响应[J].生态学报,2022,42(23):9525-9536.

[28] InVEST 数据来源, <https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/zh/data_sources.html#belowground-biomass>.

[29] Habitat Quality_InVEST, <https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/habitat_quality.html>.

[30] Meijster, Arnold, Jos BTM Roerdink, and Wim H. Hesselink. “A general algorithm for computing distance transforms in linear time.” Mathematical Morphology and its applications to image and signal processing. Springer, Boston, MA, 2002. 331-340.

[31] Crop Pollination (Pollinator Abundance),<https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/croppollination.html>.

[32] Crop Production,<https://storage.googleapis.com/releases.naturalcapitalproject.org/invest-userguide/latest/en/crop_production.html#the-model>.
